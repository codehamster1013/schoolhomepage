<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÑúÏö∏Î™ÖÎçïÏ¥àÎì±ÌïôÍµê</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Gun.js CDN for real-time data synchronization -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'ÎßëÏùÄ Í≥†Îîï', sans-serif; background: #f4f7f6; color: #333; line-height: 1.6; }
        .container { max-width: 1000px; margin: 20px auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .header { display: flex; align-items: center; justify-content: space-between; padding-bottom: 20px; border-bottom: 1px solid #eee; margin-bottom: 30px; }
        .header-left { display: flex; align-items: center; }
        .logo { width: 60px; height: 60px; border-radius: 50%; overflow: hidden; margin-right: 15px; border: 3px solid #62C18F; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .logo img { width: 100%; height: 100%; object-fit: cover; }
        .school-name { font-size: 28px; font-weight: bold; color: #333; text-shadow: 1px 1px 2px rgba(0,0,0,0.05); }
        .nav { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; justify-content: flex-start; }
        .btn { padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s ease; }
        .btn-primary { background: #62C18F; color: white; box-shadow: 0 4px 8px rgba(98, 193, 143, 0.3); }
        .btn-primary:hover { background: #4CAF80; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(98, 193, 143, 0.4); }
        .btn-secondary { background: #e0e0e0; color: #555; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-secondary:hover { background: #d0d0d0; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn-danger { background: #ff4444; color: white; }
        .btn-danger:hover { background: #cc0000; transform: translateY(-2px); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 40px; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); text-align: center; position: relative; }
        .modal h2 { margin-bottom: 25px; color: #333; font-size: 26px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; font-size: 15px; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus { border-color: #62C18F; outline: none; box-shadow: 0 0 0 3px rgba(98, 193, 143, 0.2); }
        textarea { resize: vertical; min-height: 80px; }
        .close { position: absolute; top: 15px; right: 20px; font-size: 32px; color: #aaa; cursor: pointer; transition: color 0.3s; }
        .close:hover { color: #555; }

        .section-card { background: #ffffff; padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.06); }
        .section-card h3 { font-size: 22px; color: #333; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        
        .comment-section { margin-top: 40px; }
        .comment { background: #f9f9f9; padding: 15px 20px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #eee; transition: all 0.3s ease; }
        .comment:hover { background: #f5f5f5; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .comment-author { font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; color: #444; font-size: 15px; }
        .profile { width: 34px; height: 34px; background: #62C18F; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: white; font-size: 16px; font-weight: bold; margin-right: 12px; flex-shrink: 0; }
        .comment-text { font-size: 16px; color: #333; word-wrap: break-word; }
        .comment-meta { font-size: 12px; color: #888; margin-top: 5px; display: flex; justify-content: space-between; align-items: center; }
        .comment-meta button { background: none; border: none; color: #ff6666; font-size: 12px; cursor: pointer; padding: 0 5px; transition: color 0.3s; }
        .comment-meta button:hover { color: #cc0000; }
        .comment-options { display: flex; justify-content: flex-end; align-items: center; gap: 8px; }

        .vote-section { margin: 30px 0; padding: 30px; border: 1px solid #62C18F; border-radius: 12px; background: #e6f6ee; }
        .vote-section h3 { color: #2e7d32; }
        .vote-option { margin: 15px 0; display: flex; align-items: center; }
        .vote-option label { cursor: pointer; display: flex; align-items: center; font-size: 17px; color: #333; }
        .vote-option input[type="radio"] { margin-right: 12px; width: 20px; height: 20px; accent-color: #62C18F; }
        .vote-section .btn { width: 100%; margin-top: 25px; }

        .vote-result { margin-top: 30px; padding-top: 20px; border-top: 1px dashed #b0d8c7; }
        .results-summary { background: #f0fdf7; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #d0f0e0; }
        .results-summary h4 { color: #2e7d32; margin-bottom: 15px; font-size: 18px; }
        .results-summary p { margin-bottom: 8px; font-size: 15px; }
        .results-summary p strong { color: #1e5a21; }

        .chart-toggle { text-align: center; margin-bottom: 25px; }
        .chart-toggle .btn { margin: 0 5px; padding: 8px 20px; border-radius: 20px; font-size: 14px; }
        .active-chart { background: #62C18F !important; color: white !important; box-shadow: 0 4px 8px rgba(98, 193, 143, 0.4); }

        .bar-item { margin-bottom: 20px; }
        .bar-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; font-size: 15px; color: #444; }
        .bar-container { background: #e9ecef; height: 30px; border-radius: 15px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 15px; background: #62C18F; transition: width 1s ease-out; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: white; font-size: 13px; font-weight: bold; white-space: nowrap; overflow: hidden; }
        .bar-fill span { margin-left: auto; padding-left: 5px; }
        .chart-canvas { max-width: 400px; max-height: 400px; margin: 0 auto; }
        .chart-container { display: flex; justify-content: center; align-items: center; margin-top: 20px; }

        .hidden { display: none !important; }
        .text-center { text-align: center; }
        
        .online-indicator { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: #62C18F; 
            color: white; 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-size: 14px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 999;
        }
    </style>
</head>
<body>
    <div class="online-indicator" id="onlineIndicator">
        üî¥ Ïó∞Í≤∞ Ï§ë...
    </div>

    <div id="loginModal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h2>ÌôòÏòÅÌï©ÎãàÎã§!</h2>
            <p style="margin-bottom: 20px; color: #666;">ÏÑúÏö∏Î™ÖÎçïÏ¥àÎì±ÌïôÍµê ÌôàÌéòÏù¥ÏßÄÏóê Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.</p>
            <div class="form-group">
                <label for="grade">ÌïôÎÖÑ:</label>
                <select id="grade">
                    <option value="">ÌïôÎÖÑ ÏÑ†ÌÉù</option>
                    <option value="1">1ÌïôÎÖÑ</option>
                    <option value="2">2ÌïôÎÖÑ</option>
                    <option value="3">3ÌïôÎÖÑ</option>
                    <option value="4">4ÌïôÎÖÑ</option>
                    <option value="5">5ÌïôÎÖÑ</option>
                    <option value="6">6ÌïôÎÖÑ</option>
                    <option value="--">Í¥ÄÎ¶¨Ïûê</option>
                </select>
            </div>
            <div class="form-group">
                <label for="class">Î∞ò:</label>
                <select id="class">
                    <option value="">Î∞ò ÏÑ†ÌÉù</option>
                    <option value="1">1Î∞ò</option>
                    <option value="2">2Î∞ò</option>
                    <option value="3">3Î∞ò</option>
                    <option value="4">4Î∞ò</option>
                    <option value="5">5Î∞ò</option>
                    <option value="6">6Î∞ò</option>
                    <option value="7">7Î∞ò</option>
                    <option value="8">8Î∞ò</option>
                    <option value="9">9Î∞ò</option>
                    <option value="10">10Î∞ò</option>
                    <option value="11">11Î∞ò</option>
                    <option value="--">Í¥ÄÎ¶¨Ïûê</option>
                </select>
            </div>
            <div class="form-group">
                <label for="lastName">ÏÑ±:</label>
                <input type="text" id="lastName" placeholder="Ïòà: ÍπÄ" required>
            </div>
            <div class="form-group">
                <label for="firstName">Ïù¥Î¶Ñ:</label>
                <input type="text" id="firstName" placeholder="Ïòà: Î™ÖÎçï" required>
            </div>
            <button class="btn btn-primary" onclick="login()">ÏûÖÏû•ÌïòÍ∏∞</button>
        </div>
    </div>

    <div id="mainPage" class="hidden">
        <div class="container">
            <div class="header">
                <div class="header-left">
                    <div class="logo">
                        <img src="https://myungduk.sen.es.kr/dggb/module/file/selectImageView.do?atchFileId=276396&fileSn=0" alt="ÏÑúÏö∏Î™ÖÎçïÏ¥àÎì±ÌïôÍµê Î°úÍ≥†">
                    </div>
                    <div class="school-name">ÏÑúÏö∏Î™ÖÎçïÏ¥àÎì±ÌïôÍµê</div>
                </div>
                <button class="btn btn-secondary" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
            </div>

            <div id="hostButtons" class="nav hidden">
                <button class="btn btn-primary" onclick="createVote('meal')">Í∏âÏãùÌà¨Ìëú ÏÉùÏÑ±</button>
                <button class="btn btn-primary" onclick="createVote('music')">ÏùåÏïÖÌà¨Ìëú ÏÉùÏÑ±</button>
                <button class="btn btn-primary" onclick="editNews()">ÌïôÍµê ÏÜåÏãù Ìé∏Ïßë</button>
                <button class="btn btn-danger" onclick="deleteVote()">ÌòÑÏû¨ Ìà¨Ìëú ÏÇ≠Ï†ú</button>
            </div>

            <div class="section-card news-section">
                <h3>üè´ ÌïôÍµê ÏÜåÏãù</h3>
                <div id="newsContent"></div>
            </div>

            <div id="voteSection" class="vote-section hidden">
                <h3 id="voteTitle"></h3>
                <div id="voteContent"></div>
                <div id="voteResults" class="vote-result hidden">
                    <div class="results-summary">
                        <h4>üìä Ìà¨Ìëú Í≤∞Í≥º ÏöîÏïΩ</h4>
                        <div id="voteSummary"></div>
                    </div>
                    <div class="chart-toggle">
                        <button class="btn btn-secondary active-chart" id="barBtn" onclick="showChart('bar')">ÎßâÎåÄ Í∑∏ÎûòÌîÑ Î≥¥Í∏∞</button>
                        <button class="btn btn-secondary" id="pieBtn" onclick="showChart('pie')">ÏõêÌòï Í∑∏ÎûòÌîÑ Î≥¥Í∏∞</button>
                    </div>
                    <div id="barChart"><div id="barContent"></div></div>
                    <div id="pieChart" class="chart-container hidden">
                        <canvas id="voteChart" class="chart-canvas"></canvas>
                    </div>
                </div>
            </div>

            <div class="section-card comment-section">
                <h3>üí¨ Í±¥ÏùòÌï®</h3>
                <div class="form-group">
                    <textarea id="commentText" placeholder="ÌïôÍµêÏóê Í±¥ÏùòÌïòÍ≥† Ïã∂ÏùÄ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî." rows="4"></textarea>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; font-weight: normal; margin-bottom: 0;">
                        <input type="checkbox" id="privateComment" style="width: auto; margin-right: 8px;"> ÎπÑÍ≥µÍ∞ú ÎåìÍ∏Ä
                    </label>
                    <button class="btn btn-primary" onclick="addComment()">ÎåìÍ∏Ä ÏûëÏÑ±</button>
                </div>
                <div id="comments"></div>
            </div>
        </div>
    </div>

    <div id="voteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="hideModal()">&times;</span>
            <h2 id="voteModalTitle">Ìà¨Ìëú ÏÉùÏÑ±</h2>
            <div class="form-group">
                <label for="voteTitle2">Ìà¨Ìëú Ï†úÎ™©:</label>
                <input type="text" id="voteTitle2" placeholder="Ïòà: Ïù¥Î≤à Ï£º Í∏âÏãù Î©îÎâ¥ Ìà¨Ìëú">
            </div>
            <div class="form-group">
                <label for="voteOptions">Ìà¨Ìëú ÏÑ†ÌÉùÏßÄ (Í∞Å Ï§ÑÏóê ÌïòÎÇòÏî© ÏûÖÎ†•):</label>
                <textarea id="voteOptions" rows="6" placeholder="ÏÑ†ÌÉùÏßÄ 1&#10;ÏÑ†ÌÉùÏßÄ 2&#10;ÏÑ†ÌÉùÏßÄ 3"></textarea>
            </div>
            <div class="form-group">
                <label for="voteDays">Ìà¨Ìëú Í∏∞Í∞Ñ (Ïùº):</label>
                <input type="number" id="voteDays" value="7" min="1">
            </div>
            <button class="btn btn-primary" onclick="startVote()">Ìà¨Ìëú ÏãúÏûë</button>
        </div>
    </div>

    <script>
        // Initialize Gun.js for real-time data synchronization
        const gun = Gun();
        const schoolData = gun.get('myungduk-school');
        const commentsDB = schoolData.get('comments');
        const newsDB = schoolData.get('news');
        const voteDB = schoolData.get('vote');

        // Local data storage
        let currentUser = null;
        let currentVote = null;
        let voteChart = null;
        const colors = ['#62C18F', '#FFD700', '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#A3C8B7', '#8B0000'];
        let processedComments = new Set(); // Track processed comment IDs to avoid duplicates
        let processedVotes = new Set(); // Track processed votes to avoid duplicates

        // Connection status indicator
        gun.on('hi', () => {
            document.getElementById('onlineIndicator').innerHTML = 'üü¢ Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞Îê®';
        });

        gun.on('bye', () => {
            document.getElementById('onlineIndicator').innerHTML = 'üî¥ Ïó∞Í≤∞ ÎÅäÍπÄ';
        });

        // Real-time listeners
        function initializeRealTimeListeners() {
            // Listen for new comments
            commentsDB.map().on((data, id) => {
                if (!data || processedComments.has(id)) return;
                processedComments.add(id);
                displayComment(data);
            });

            // Listen for news updates
            newsDB.on((data) => {
                if (data && data.content) {
                    document.getElementById('newsContent').innerHTML = data.content;
                }
            });

            // Listen for vote updates
            voteDB.on((data) => {
                if (data) {
                    currentVote = data;
                    loadVote();
                }
            });

            // Listen for vote submissions
            voteDB.get('votes').map().on((data, id) => {
                if (!data || processedVotes.has(id)) return;
                processedVotes.add(id);
                if (currentVote && data.optionIndex !== undefined) {
                    currentVote.options[data.optionIndex].votes++;
                    updateVoteDisplay();
                }
            });
        }

        // --- Login/Logout Functions ---
        function login() {
            const grade = document.getElementById('grade').value;
            const cls = document.getElementById('class').value;
            const lastName = document.getElementById('lastName').value.trim();
            const firstName = document.getElementById('firstName').value.trim();

            if (!grade || !cls || !lastName || !firstName) {
                alert('Î™®Îì† Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const isHost = grade === '--' && cls === '--';
            currentUser = { grade, class: cls, lastName, firstName, isHost };

            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('mainPage').classList.remove('hidden');

            if (isHost) {
                document.getElementById('hostButtons').classList.remove('hidden');
            }

            initializeRealTimeListeners();
            loadContent();
        }

        function logout() {
            currentUser = null;
            processedComments.clear();
            processedVotes.clear();
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('hostButtons').classList.add('hidden');
            document.getElementById('comments').innerHTML = '';
        }

        function loadContent() {
            // Load initial news
            newsDB.once((data) => {
                if (data && data.content) {
                    document.getElementById('newsContent').innerHTML = data.content;
                } else {
                    const defaultNews = 'ÏïàÎÖïÌïòÏÑ∏Ïöî! ÏÑúÏö∏Î™ÖÎçïÏ¥àÎì±ÌïôÍµê ÌôàÌéòÏù¥ÏßÄÏûÖÎãàÎã§.';
                    newsDB.put({ content: defaultNews, timestamp: Gun.state() });
                }
            });

            // Load initial vote
            voteDB.once((data) => {
                if (data) {
                    currentVote = data;
                    loadVote();
                }
            });
        }

        // --- Comment Functions ---
        function addComment() {
            const text = document.getElementById('commentText').value.trim();
            if (!text) {
                alert('ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // Basic profanity filter
            const forbiddenWords = ['Ïî®Î∞ú', 'Ïî®Î∞úÎÖÑ', 'Ïî®Î∞úÎÜà', 'Ïî®Î≤å', 'Ïî®Î∂ÄÎûÑ', 'Ïî®Î∂ÄÎûÑÎÖÑ', 'Ïî®Î≤åÎÖÑ','ÏßÄÎûÑ','fuck','mother','shut'];
            for (let word of forbiddenWords) {
                if (text.includes(word)) {
                    alert('Î∂ÄÏ†ÅÏ†àÌïú ÎÇ¥Ïö©Ïù¥ Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§.');
                    return;
                }
            }

            const comment = {
                author: currentUser.firstName,
                profile: currentUser.firstName[0] || '?',
                text: text,
                private: document.getElementById('privateComment').checked,
                timestamp: new Date().toLocaleString('ko-KR'),
                id: Gun.state()
            };

            commentsDB.set(comment);
            document.getElementById('commentText').value = '';
            document.getElementById('privateComment').checked = false;
        }

        function displayComment(comment) {
            // Only show private comments to host or the author
            if (comment.private && !currentUser.isHost && comment.author !== currentUser.firstName) {
                return;
            }

            const container = document.getElementById('comments');
            const div = document.createElement('div');
            div.className = 'comment';
            div.innerHTML = `
                <div class="comment-author">
                    <span class="profile">${comment.profile}</span>
                    ${comment.author}
                    ${comment.private ? '<span style="color:#888; font-weight:normal; margin-left: 5px;">(ÎπÑÍ≥µÍ∞ú)</span>' : ''}
                </div>
                <div class="comment-text">${comment.text}</div>
                <div class="comment-meta">
                    <small>${comment.timestamp}</small>
                </div>
            `;
            container.insertBefore(div, container.firstChild);
        }

        // --- Vote Functions ---
        function createVote(type) {
            if (!currentUser.isHost) {
                alert('Ìà¨ÌëúÎäî Í¥ÄÎ¶¨ÏûêÎßå ÏÉùÏÑ±Ìï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }
            document.getElementById('voteModalTitle').textContent = type === 'meal' ? 'Í∏âÏãù Ìà¨Ìëú ÏÉùÏÑ±' : 'ÏùåÏïÖ Ìà¨Ìëú ÏÉùÏÑ±';
            document.getElementById('voteModal').style.display = 'flex';
            document.getElementById('voteTitle2').value = '';
            document.getElementById('voteOptions').value = '';
            document.getElementById('voteDays').value = 7;
        }

        function hideModal() {
            document.getElementById('voteModal').style.display = 'none';
        }

        function startVote() {
            const title = document.getElementById('voteTitle2').value.trim();
            const optionsText = document.getElementById('voteOptions').value.trim();
            const days = parseInt(document.getElementById('voteDays').value);

            if (!title || !optionsText) {
                alert('Ìà¨Ìëú Ï†úÎ™©Í≥º ÏÑ†ÌÉùÏßÄÎ•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const options = optionsText.split('\n').filter(o => o.trim()).map(o => o.trim());
            if (options.length < 2) {
                alert('ÏµúÏÜå 2Í∞ú Ïù¥ÏÉÅÏùò ÏÑ†ÌÉùÏßÄÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const endTime = new Date();
            endTime.setDate(endTime.getDate() + days);

            const vote = {
                title: title,
                options: options.map(o => ({ text: o, votes: 0 })),
                endTime: endTime.getTime(),
                voters: [],
                resultsPublished: false,
                timestamp: Gun.state()
            };

            voteDB.put(vote);
            processedVotes.clear(); // Reset processed votes for new vote
            document.getElementById('voteModal').style.display = 'none';
            alert('ÏÉàÎ°úÏö¥ Ìà¨ÌëúÍ∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!');
        }

        function loadVote() {
            if (!currentVote) {
                document.getElementById('voteSection').classList.add('hidden');
                return;
            }

            document.getElementById('voteSection').classList.remove('hidden');
            document.getElementById('voteTitle').textContent = currentVote.title;
            const container = document.getElementById('voteContent');
            container.innerHTML = '';
            document.getElementById('voteResults').classList.add('hidden');

            const hasVoted = currentVote.voters && currentVote.voters.includes(currentUser.lastName + currentUser.firstName);
            const voteEnded = new Date().getTime() > currentVote.endTime;

            if (voteEnded) {
                showVoteResults();
                return;
            }

            currentVote.options.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'vote-option';
                div.innerHTML = `
                    <label>
                        <input type="radio" name="vote" value="${index}" ${hasVoted ? 'disabled' : ''}>
                        ${option.text}
                    </label>
                `;
                container.appendChild(div);
            });

            if (!hasVoted) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary';
                btn.textContent = 'Ìà¨ÌëúÌïòÍ∏∞';
                btn.onclick = submitVote;
                container.appendChild(btn);
            } else {
                container.innerHTML += `<p class="text-center" style="margin-top:20px; color:#555;">Ïù¥ÎØ∏ Ìà¨ÌëúÏóê Ï∞∏Ïó¨ÌïòÏÖ®ÏäµÎãàÎã§.</p>`;
            }
            
            container.innerHTML += `<p class="text-center" style="margin-top:20px; color:#777;"><small>ÎßàÍ∞ê: ${new Date(currentVote.endTime).toLocaleString('ko-KR')}</small></p>`;
        }

        function submitVote() {
            const selected = document.querySelector('input[name="vote"]:checked');
            if (!selected) {
                alert('Ìà¨ÌëúÌï† Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const voterKey = currentUser.lastName + currentUser.firstName;
            if (currentVote.voters && currentVote.voters.includes(voterKey)) {
                alert('Ïù¥ÎØ∏ Ìà¨ÌëúÏóê Ï∞∏Ïó¨ÌïòÏÖ®ÏäµÎãàÎã§.');
                return;
            }

            // Add vote to database
            const voteData = {
                optionIndex: parseInt(selected.value),
                voter: voterKey,
                timestamp: Gun.state()
            };
            voteDB.get('votes').set(voteData);

            // Update current vote data
            if (!currentVote.voters) currentVote.voters = [];
            currentVote.voters.push(voterKey);
            currentVote.options[parseInt(selected.value)].votes++;
            
            // Update vote in database
            voteDB.put(currentVote);
            
            alert('Ìà¨ÌëúÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!');
        }

        function updateVoteDisplay() {
            if (document.getElementById('voteResults').classList.contains('hidden')) {
                loadVote(); // Refresh vote display
            } else {
                showVoteResults(); // Update results if already showing
            }
        }

        function showVoteResults() {
            if (!currentVote) return;

            document.getElementById('voteContent').classList.add('hidden');
            document.getElementById('voteResults').classList.remove('hidden');

            const totalVotes = currentVote.options.reduce((sum, opt) => sum + opt.votes, 0);
            const sortedOptions = [...currentVote.options].sort((a, b) => b.votes - a.votes);
            const winner = sortedOptions[0];

            document.getElementById('voteSummary').innerHTML = `
                <p><strong>Ï¥ù Ìà¨Ìëú Ïàò:</strong> ${totalVotes}Ìëú</p>
                <p><strong>Ï∞∏Ïó¨Ìïú ÌïôÏÉù Ïàò:</strong> ${currentVote.voters ? currentVote.voters.length : 0}Î™Ö</p>
                <p><strong>üèÜ 1ÏúÑ:</strong> ${winner.text} (${winner.votes}Ìëú)</p>
            `;
            
            if (!currentVote.resultsPublished) {
                const resultNews = `üìä ${currentVote.title} Í≤∞Í≥º Î∞úÌëú!\nüèÜ 1ÏúÑ: ${winner.text} (${winner.votes}Ìëú)\nÏ¥ù ${totalVotes}Ìëú Ìà¨Ìëú\n\n`;
                newsDB.once((data) => {
                    const currentNews = data && data.content ? data.content : '';
                    newsDB.put({
                        content: resultNews + currentNews,
                        timestamp: Gun.state()
                    });
                });
                currentVote.resultsPublished = true;
                voteDB.put(currentVote);
            }

            createBarChart();
            createPieChart();
            showChart('bar');
        }

        function createBarChart() {
            const container = document.getElementById('barContent');
            container.innerHTML = '';
            const total = currentVote.options.reduce((sum, opt) => sum + opt.votes, 0);
            
            const sortedOptions = [...currentVote.options].sort((a, b) => b.votes - a.votes);

            sortedOptions.forEach((option, index) => {
                const percentage = total > 0 ? (option.votes / total) * 100 : 0;
                const div = document.createElement('div');
                div.className = 'bar-item';
                div.innerHTML = `
                    <div class="bar-label">
                        <span><strong>${option.text}</strong></span>
                        <span>${option.votes}Ìëú (${percentage.toFixed(1)}%)</span>
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill" style="background: ${colors[index % colors.length]}; width: ${percentage}%;">
                            ${percentage > 5 ? `${percentage.toFixed(1)}%` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function createPieChart() {
            const ctx = document.getElementById('voteChart').getContext('2d');
            if (voteChart) voteChart.destroy();

            const labels = currentVote.options.map(o => o.text);
            const data = currentVote.options.map(o => o.votes);
            const total = data.reduce((sum, votes) => sum + votes, 0);

            voteChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: { size: 13 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = total > 0 ? (context.parsed / total) * 100 : 0;
                                    return `${context.label}: ${context.parsed}Ìëú (${percentage.toFixed(1)}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function showChart(type) {
            document.getElementById('barBtn').classList.remove('active-chart');
            document.getElementById('pieBtn').classList.remove('active-chart');
            if (type === 'bar') {
                document.getElementById('barChart').classList.remove('hidden');
                document.getElementById('pieChart').classList.add('hidden');
                document.getElementById('barBtn').classList.add('active-chart');
            } else {
                document.getElementById('barChart').classList.add('hidden');
                document.getElementById('pieChart').classList.remove('hidden');
                document.getElementById('pieBtn').classList.add('active-chart');
            }
        }

        function editNews() {
            if (!currentUser.isHost) {
                alert('ÌïôÍµê ÏÜåÏãùÏùÄ Í¥ÄÎ¶¨ÏûêÎßå Ìé∏ÏßëÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }
            
            newsDB.once((data) => {
                const currentNews = data && data.content ? data.content : 'ÏïàÎÖïÌïòÏÑ∏Ïöî! ÏÑúÏö∏Î™ÖÎçïÏ¥àÎì±ÌïôÍµê ÌôàÌéòÏù¥ÏßÄÏûÖÎãàÎã§.';
                const newNews = prompt('ÏÉàÎ°úÏö¥ ÌïôÍµê ÏÜåÏãùÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî:', currentNews);
                if (newNews !== null) {
                    newsDB.put({
                        content: newNews,
                        timestamp: Gun.state()
                    });
                    alert('ÌïôÍµê ÏÜåÏãùÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.');
                }
            });
        }

        function deleteVote() {
            if (!currentUser.isHost) {
                alert('Ìà¨ÌëúÎäî Í¥ÄÎ¶¨ÏûêÎßå ÏÇ≠Ï†úÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }
            if (!currentVote) {
                alert('ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ Ìà¨ÌëúÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            if (confirm('ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ Ìà¨ÌëúÎ•º Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ìà¨Ìëú Í≤∞Í≥ºÎèÑ Ìï®Íªò ÏÇ¨ÎùºÏßëÎãàÎã§.')) {
                voteDB.put(null);
                voteDB.get('votes').put(null);
                currentVote = null;
                processedVotes.clear();
                document.getElementById('voteSection').classList.add('hidden');
                alert('Ìà¨ÌëúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            }
        }

        // Check vote end time periodically
        setInterval(() => {
            if (currentVote && new Date().getTime() > currentVote.endTime && !document.getElementById('voteResults').classList.contains('hidden') === false) {
                showVoteResults();
            }
        }, 60000);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Set connection indicator
            setTimeout(() => {
                if (document.getElementById('onlineIndicator').innerHTML.includes('Ïó∞Í≤∞ Ï§ë')) {
                    document.getElementById('onlineIndicator').innerHTML = 'üü¢ Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞Îê®';
                }
            }, 2000);
        });
    </script>
</body>
</html>
