<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œìš¸ëª…ë•ì´ˆë“±í•™êµ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'ë§‘ì€ ê³ ë”•', sans-serif; background: #f5f7fa; line-height: 1.6; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .login-card, .main-card { background: white; border-radius: 12px; padding: 30px; margin: 20px 0; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; }
        input:focus, select:focus, textarea:focus { border-color: #667eea; outline: none; }
        .btn { background: #667eea; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: all 0.3s; }
        .btn:hover { background: #5a6fd8; transform: translateY(-2px); }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219a52; }
        .btn-warning { background: #f39c12; }
        .btn-warning:hover { background: #d68910; }
        .btn-small { padding: 8px 16px; font-size: 14px; }
        .vote-item { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin: 15px 0; position: relative; }
        .vote-item.active { border-color: #667eea; background: #f0f3ff; }
        .vote-item.expired { border-color: #e74c3c; background: #fdf2f2; }
        .chart-container { width: 100%; height: 300px; margin: 20px 0; }
        .suggestions { position: fixed; top: 20px; right: 20px; z-index: 100; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .close { float: right; font-size: 24px; cursor: pointer; color: #999; }
        .close:hover { color: #333; }
        .suggestion-item { background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 4px solid #667eea; }
        .profile-circle { width: 40px; height: 40px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 10px; }
        .user-info { background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .vote-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .vote-option { background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .vote-option:hover { border-color: #667eea; background: #f0f3ff; }
        .vote-option.selected { border-color: #667eea; background: #667eea; color: white; }
        .vote-option.disabled { background: #f5f5f5; color: #999; cursor: not-allowed; border-color: #ddd; }
        .admin-panel { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .hidden { display: none; }
        .error { color: #e74c3c; font-size: 14px; margin-top: 5px; }
        .success { color: #27ae60; font-size: 14px; margin-top: 5px; }
        .admin-hint { background: #e8f5e8; border: 1px solid #c3e6c3; border-radius: 6px; padding: 10px; margin-top: 10px; font-size: 14px; color: #2d5016; }
        .public-suggestions { background: white; border-radius: 12px; padding: 20px; margin: 20px 0; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .countdown { background: #667eea; color: white; padding: 10px; border-radius: 6px; margin: 10px 0; text-align: center; font-weight: bold; }
        .expired-badge { background: #e74c3c; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; position: absolute; top: 10px; right: 10px; }
        .time-left { color: #667eea; font-weight: bold; margin: 5px 0; }
        .datetime-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ« ì„œìš¸ëª…ë•ì´ˆë“±í•™êµ</h1>
        <p>í•™ê¸‰ íˆ¬í‘œ ë° ê±´ì˜ ì‹œìŠ¤í…œ</p>
    </div>

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="container">
        <div class="login-card">
            <h2>í•™ìƒ ì •ë³´ ì…ë ¥</h2>
            <div class="form-group">
                <label>í•™ë…„</label>
                <select id="grade">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="1">1í•™ë…„</option>
                    <option value="2">2í•™ë…„</option>
                    <option value="3">3í•™ë…„</option>
                    <option value="4">4í•™ë…„</option>
                    <option value="5">5í•™ë…„</option>
                    <option value="6">6í•™ë…„</option>
                </select>
            </div>
            <div class="form-group">
                <label>ë°˜</label>
                <select id="class">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option><option value="4">4ë°˜</option><option value="5">5ë°˜</option>
                    <option value="6">6ë°˜</option><option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option><option value="10">10ë°˜</option><option value="11">11ë°˜</option>
                </select>
            </div>
            <div class="form-group">
                <label>ì„±</label>
                <input type="text" id="lastName" placeholder="ì„±ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
            </div>
            <div class="form-group">
                <label>ì´ë¦„</label>
                <input type="text" id="firstName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
            </div>
            <div class="admin-hint">
            </div>
            <button class="btn" onclick="login()">ì…ì¥í•˜ê¸°</button>
            <div id="loginError" class="error"></div>
        </div>
    </div>

    <!-- ë©”ì¸ í™”ë©´ -->
    <div id="mainScreen" class="hidden">
        <div class="suggestions">
            <button class="btn btn-small" onclick="openSuggestionModal()">ğŸ’¬ ê±´ì˜í•˜ê¸°</button>
            <button class="btn btn-small" onclick="viewAllSuggestions()" style="margin-left: 10px;">ğŸ“‹ ê±´ì˜ì‚¬í•­ ë³´ê¸°</button>
        </div>

        <div class="container">
            <div id="userInfo" class="user-info"></div>

            <!-- ê´€ë¦¬ì íŒ¨ë„ -->
            <div id="adminPanel" class="admin-panel hidden">
                <h3>ğŸ”§ ê´€ë¦¬ì íŒ¨ë„</h3>
                <button class="btn btn-small" onclick="openVoteCreateModal()">íˆ¬í‘œ ë§Œë“¤ê¸°</button>
                <button class="btn btn-danger btn-small" onclick="viewSuggestions()">ê±´ì˜ì‚¬í•­ ê´€ë¦¬</button>
            </div>

            <!-- íˆ¬í‘œ ëª©ë¡ -->
            <div class="main-card">
                <h2>ğŸ“Š í˜„ì¬ ì§„í–‰ì¤‘ì¸ íˆ¬í‘œ</h2>
                <div id="votesList"></div>
            </div>

            <!-- ì™„ë£Œëœ íˆ¬í‘œ ê²°ê³¼ -->
            <div class="main-card">
                <h2>ğŸ“ˆ íˆ¬í‘œ ê²°ê³¼</h2>
                <div id="completedVotes"></div>
            </div>

            <!-- ê³µê°œ ê±´ì˜ì‚¬í•­ -->
            <div class="public-suggestions">
                <h2>ğŸ’¬ ê±´ì˜ì‚¬í•­</h2>
                <div id="publicSuggestionsList"></div>
            </div>
        </div>
    </div>

    <!-- íˆ¬í‘œ ìƒì„± ëª¨ë‹¬ -->
    <div id="voteCreateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('voteCreateModal')">&times;</span>
            <h3>ìƒˆ íˆ¬í‘œ ë§Œë“¤ê¸°</h3>
            <div class="form-group">
                <label>íˆ¬í‘œ ìœ í˜•</label>
                <select id="voteType">
                    <option value="meal">ê¸‰ì‹ íˆ¬í‘œ</option>
                    <option value="music">ìŒì•…ë°©ì†¡ íˆ¬í‘œ</option>
                    <option value="activity">ì²´í—˜í™œë™ íˆ¬í‘œ</option>
                    <option value="event">í•™ê¸‰í–‰ì‚¬ íˆ¬í‘œ</option>
                    <option value="other">ê¸°íƒ€</option>
                </select>
            </div>
            <div class="form-group">
                <label>ì œëª©</label>
                <input type="text" id="voteTitle" placeholder="íˆ¬í‘œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
                <label>íˆ¬í‘œ ê¸°ê°„</label>
                <div class="datetime-group">
                    <div>
                        <label style="font-size: 14px;">ì¢…ë£Œ ë‚ ì§œ</label>
                        <input type="date" id="voteEndDate">
                    </div>
                    <div>
                        <label style="font-size: 14px;">ì¢…ë£Œ ì‹œê°„</label>
                        <input type="time" id="voteEndTime">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>ì„ íƒì§€ (ê° ì¤„ì— í•˜ë‚˜ì”©)</label>
                <textarea id="voteOptions" rows="5" placeholder="ì„ íƒì§€1&#10;ì„ íƒì§€2&#10;ì„ íƒì§€3"></textarea>
            </div>
            <button class="btn" onclick="createVote()">íˆ¬í‘œ ìƒì„±</button>
            <div id="createVoteError" class="error"></div>
        </div>
    </div>

    <!-- ê±´ì˜ì‚¬í•­ ëª¨ë‹¬ -->
    <div id="suggestionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('suggestionModal')">&times;</span>
            <h3>ğŸ’¬ ê±´ì˜í•˜ê¸°</h3>
            <div class="form-group">
                <label>í”„ë¡œí•„ ìƒ‰ìƒ</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <div class="profile-circle" style="background: #e74c3c; cursor: pointer;" onclick="selectProfile('#e74c3c')">A</div>
                    <div class="profile-circle" style="background: #3498db; cursor: pointer;" onclick="selectProfile('#3498db')">B</div>
                    <div class="profile-circle" style="background: #2ecc71; cursor: pointer;" onclick="selectProfile('#2ecc71')">C</div>
                    <div class="profile-circle" style="background: #f39c12; cursor: pointer;" onclick="selectProfile('#f39c12')">D</div>
                    <div class="profile-circle" style="background: #9b59b6; cursor: pointer;" onclick="selectProfile('#9b59b6')">E</div>
                    <div class="profile-circle" style="background: #34495e; cursor: pointer;" onclick="selectProfile('#34495e')">F</div>
                </div>
                <input type="hidden" id="selectedProfile" value="#3498db">
            </div>
            <div class="form-group">
                <label>ê±´ì˜ ë‚´ìš©</label>
                <textarea id="suggestionContent" rows="4" placeholder="ê±´ì˜ì‚¬í•­ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..." maxlength="500"></textarea>
            </div>
            <button class="btn" onclick="submitSuggestion()">ê±´ì˜í•˜ê¸°</button>
            <div id="suggestionError" class="error"></div>
        </div>
    </div>

    <!-- ê±´ì˜ì‚¬í•­ ê´€ë¦¬ ëª¨ë‹¬ (ê´€ë¦¬ììš©) -->
    <div id="suggestionsViewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('suggestionsViewModal')">&times;</span>
            <h3>ğŸ“‹ ê±´ì˜ì‚¬í•­ ê´€ë¦¬</h3>
            <div id="suggestionsList"></div>
        </div>
    </div>

    <!-- ê±´ì˜ì‚¬í•­ ë³´ê¸° ëª¨ë‹¬ (ì¼ë°˜ ì‚¬ìš©ììš©) -->
    <div id="publicSuggestionsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('publicSuggestionsModal')">&times;</span>
            <h3>ğŸ“‹ ê±´ì˜ì‚¬í•­ ë³´ê¸°</h3>
            <div id="publicSuggestionsModalList"></div>
        </div>
    </div>

    <script>
        // Supabase ì´ˆê¸°í™” - ì‹¤ì œ í”„ë¡œì íŠ¸ì—ì„œëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬í•˜ì„¸ìš”
        const SUPABASE_URL = 'https://xyhdojgynscpjxlqnrul.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5aGRvamd5bnNjcGp4bHFucnVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMDI0MjAsImV4cCI6MjA3MDg3ODQyMH0.pGZzTeO_vbVIJioICKMyUIFUiHhKkTPOyDoM5QygcNw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let selectedProfileColor = '#3498db';
        let countdownTimers = {};

        // ìš•ì„¤ í•„í„°ë§
        const badWords = ['ë°”ë³´', 'ë©ì²­ì´', 'ì£½ì–´', 'êº¼ì ¸', 'ì‹œë°œ', 'ë³‘ì‹ ', 'ê°œìƒˆë¼', 'ì”¨ë°œ'];
        
        function containsBadWords(text) {
            return badWords.some(word => text.toLowerCase().includes(word));
        }

        // ë¡œê·¸ì¸
        async function login() {
            const grade = document.getElementById('grade').value;
            const classNum = document.getElementById('class').value;
            const lastName = document.getElementById('lastName').value.trim();
            const firstName = document.getElementById('firstName').value.trim();

            if (!grade || !classNum || !lastName || !firstName) {
                document.getElementById('loginError').textContent = 'ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }

            if (containsBadWords(lastName + firstName)) {
                document.getElementById('loginError').textContent = 'ë¶€ì ì ˆí•œ ì´ë¦„ì…ë‹ˆë‹¤.';
                return;
            }

            // ê´€ë¦¬ì ì¸ì¦: ì„±ì´ "ì„œìš¸"ì´ê³  ì´ë¦„ì´ "ëª…ë•ì´ˆë“±í•™êµ"ì¸ ê²½ìš°
            const isAdmin = (lastName === 'ì„œìš¸' && firstName === 'ëª…ë•ì´ˆë“±í•™êµ');

            currentUser = {
                grade: parseInt(grade),
                class: parseInt(classNum),
                name: lastName + firstName,
                isAdmin: isAdmin,
                id: `${grade}${classNum}_${lastName}${firstName}`
            };

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            
            showUserInfo();
            if (isAdmin) {
                document.getElementById('adminPanel').classList.remove('hidden');
            }
            
            loadVotes();
            loadCompletedVotes();
            loadPublicSuggestions();
        }

        function showUserInfo() {
            const userInfo = `
                <strong>${currentUser.grade}í•™ë…„ ${currentUser.class}ë°˜ ${currentUser.name}</strong>
                ${currentUser.isAdmin ? ' (ê´€ë¦¬ì)' : ''}
            `;
            document.getElementById('userInfo').innerHTML = userInfo;
        }

        // ì‹œê°„ í˜•ì‹ ë³€í™˜
        function formatTimeLeft(endTime) {
            const now = new Date();
            const end = new Date(endTime);
            const diff = end - now;

            if (diff <= 0) return 'íˆ¬í‘œ ì¢…ë£Œ';

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            if (days > 0) return `${days}ì¼ ${hours}ì‹œê°„ ë‚¨ìŒ`;
            if (hours > 0) return `${hours}ì‹œê°„ ${minutes}ë¶„ ë‚¨ìŒ`;
            return `${minutes}ë¶„ ë‚¨ìŒ`;
        }

        // íˆ¬í‘œ ê¸°ê°„ í™•ì¸
        function isVoteExpired(endTime) {
            return new Date() > new Date(endTime);
        }

        // íˆ¬í‘œ ë¡œë“œ
        async function loadVotes() {
            try {
                const { data: votes } = await supabase
                    .from('votes')
                    .select('*')
                    .eq('is_completed', false)
                    .order('created_at', { ascending: false });

                const votesList = document.getElementById('votesList');
                if (!votes || votes.length === 0) {
                    votesList.innerHTML = '<p>ì§„í–‰ì¤‘ì¸ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ë¦¬
                Object.values(countdownTimers).forEach(timer => clearInterval(timer));
                countdownTimers = {};

                votesList.innerHTML = votes.map(vote => {
                    const expired = vote.end_time && isVoteExpired(vote.end_time);
                    const timeLeft = vote.end_time ? formatTimeLeft(vote.end_time) : '';
                    
                    return `
                        <div class="vote-item ${expired ? 'expired' : ''}">
                            ${expired ? '<div class="expired-badge">íˆ¬í‘œ ì¢…ë£Œ</div>' : ''}
                            <h3>${vote.title}</h3>
                            <p><strong>${getVoteTypeLabel(vote.type)}</strong></p>
                            ${vote.end_time ? `<div class="time-left" id="timeLeft_${vote.id}">${timeLeft}</div>` : ''}
                            <div class="vote-options" id="options_${vote.id}">
                                ${vote.options.map((option, idx) => 
                                    `<div class="vote-option ${expired ? 'disabled' : ''}" 
                                        onclick="${expired ? '' : `selectOption(${vote.id}, ${idx})`}">${option}</div>`
                                ).join('')}
                            </div>
                            <div style="margin-top: 15px;">
                                ${!expired ? `<button class="btn btn-small" onclick="vote(${vote.id})">íˆ¬í‘œí•˜ê¸°</button>` : ''}
                                ${currentUser.isAdmin ? `
                                    <button class="btn btn-danger btn-small" onclick="deleteVote(${vote.id})" style="margin-left: 10px;">ì‚­ì œ</button>
                                    <button class="btn btn-small" onclick="completeVote(${vote.id})" style="margin-left: 10px;">íˆ¬í‘œ ì™„ë£Œ</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                // ì‹¤ì‹œê°„ ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
                votes.forEach(vote => {
                    if (vote.end_time && !isVoteExpired(vote.end_time)) {
                        startCountdown(vote.id, vote.end_time);
                    }
                });
            } catch (error) {
                console.error('íˆ¬í‘œ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸ ì‹œì‘
        function startCountdown(voteId, endTime) {
            const timer = setInterval(() => {
                const timeLeftElement = document.getElementById(`timeLeft_${voteId}`);
                if (timeLeftElement) {
                    const timeLeft = formatTimeLeft(endTime);
                    timeLeftElement.textContent = timeLeft;
                    
                    if (isVoteExpired(endTime)) {
                        clearInterval(timer);
                        loadVotes(); // íˆ¬í‘œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        loadCompletedVotes(); // ì™„ë£Œëœ íˆ¬í‘œì— ìë™ ì¶”ê°€ë  ìˆ˜ ìˆë„ë¡
                    }
                }
            }, 60000); // 1ë¶„ë§ˆë‹¤ ì—…ë°ì´íŠ¸

            countdownTimers[voteId] = timer;
        }

        function getVoteTypeLabel(type) {
            const labels = {
                'meal': 'ê¸‰ì‹íˆ¬í‘œ',
                'music': 'ìŒì•…ë°©ì†¡íˆ¬í‘œ',
                'activity': 'ì²´í—˜í™œë™íˆ¬í‘œ',
                'event': 'í•™ê¸‰í–‰ì‚¬íˆ¬í‘œ',
                'other': 'ê¸°íƒ€íˆ¬í‘œ'
            };
            return labels[type] || 'íˆ¬í‘œ';
        }

        // ì™„ë£Œëœ íˆ¬í‘œ ê²°ê³¼ ë¡œë“œ
        async function loadCompletedVotes() {
            try {
                // ì™„ë£Œëœ íˆ¬í‘œì™€ ê¸°ê°„ì´ ì§€ë‚œ íˆ¬í‘œ ëª¨ë‘ ê°€ì ¸ì˜¤ê¸°
                const { data: votes } = await supabase
                    .from('votes')
                    .select('*')
                    .or('is_completed.eq.true,end_time.lt.' + new Date().toISOString())
                    .order('completed_at', { ascending: false });

                const completedVotes = document.getElementById('completedVotes');
                if (!votes || votes.length === 0) {
                    completedVotes.innerHTML = '<p>ì™„ë£Œëœ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                completedVotes.innerHTML = votes.map(vote => {
                    const chartId = `chart_${vote.id}`;
                    const isExpired = vote.end_time && isVoteExpired(vote.end_time);
                    
                    return `
                        <div class="vote-item">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h3>${vote.title} ${isExpired && !vote.is_completed ? '(ê¸°ê°„ ë§Œë£Œ)' : '(ì™„ë£Œ)'}</h3>
                                    <p><strong>${getVoteTypeLabel(vote.type)}</strong></p>
                                </div>
                                ${currentUser.isAdmin ? `
                                    <div>
                                        <button class="btn btn-warning btn-small" onclick="clearVoteResults(${vote.id})" style="margin-right: 10px;">ê²°ê³¼ ì´ˆê¸°í™”</button>
                                        <button class="btn btn-danger btn-small" onclick="deleteVote(${vote.id})">ì‚­ì œ</button>
                                    </div>
                                ` : ''}
                            </div>
                            <canvas id="${chartId}" class="chart-container"></canvas>
                        </div>
                    `;
                }).join('');

                // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
                votes.forEach(vote => {
                    setTimeout(() => drawChart(vote), 100);
                });
            } catch (error) {
                console.error('ì™„ë£Œëœ íˆ¬í‘œ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        async function drawChart(vote) {
            const ctx = document.getElementById(`chart_${vote.id}`);
            if (!ctx) return;

            try {
                // ì‹¤ì‹œê°„ íˆ¬í‘œ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
                const { data: results } = await supabase
                    .from('vote_results')
                    .select('*')
                    .eq('vote_id', vote.id);

                const labels = vote.options;
                const data = labels.map((_, idx) => results ? results.filter(r => r.option === idx).length : 0);
                const totalVotes = data.reduce((sum, count) => sum + count, 0);

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'íˆ¬í‘œ ìˆ˜',
                            data: data,
                            backgroundColor: '#667eea',
                            borderColor: '#5a6fd8',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `ì´ íˆ¬í‘œ ìˆ˜: ${totalVotes}ëª…`
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì°¨íŠ¸ ê·¸ë¦¬ê¸° ì‹¤íŒ¨:', error);
            }
        }

        // íˆ¬í‘œ ê²°ê³¼ ì´ˆê¸°í™”
        async function clearVoteResults(voteId) {
            if (!confirm('ì •ë§ë¡œ ì´ íˆ¬í‘œì˜ ëª¨ë“  ê²°ê³¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            try {
                // íˆ¬í‘œ ê²°ê³¼ í…Œì´ë¸”ì—ì„œ í•´ë‹¹ íˆ¬í‘œì˜ ëª¨ë“  ê²°ê³¼ ì‚­ì œ
                const { error } = await supabase
                    .from('vote_results')
                    .delete()
                    .eq('vote_id', voteId);

                if (error) throw error;

                // íˆ¬í‘œ í…Œì´ë¸”ì˜ results í•„ë“œë„ nullë¡œ ì—…ë°ì´íŠ¸
                await supabase
                    .from('votes')
                    .update({ results: null })
                    .eq('id', voteId);

                alert('íˆ¬í‘œ ê²°ê³¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadCompletedVotes();
            } catch (error) {
                console.error('íˆ¬í‘œ ê²°ê³¼ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                alert('íˆ¬í‘œ ê²°ê³¼ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // íˆ¬í‘œ ì„ íƒ
        function selectOption(voteId, optionIdx) {
            const options = document.querySelectorAll(`#options_${voteId} .vote-option:not(.disabled)`);
            options.forEach((opt, idx) => {
                opt.classList.toggle('selected', idx === optionIdx);
            });
        }

        // íˆ¬í‘œí•˜ê¸°
        async function vote(voteId) {
            // íˆ¬í‘œ ê¸°ê°„ í™•ì¸
            const { data: voteData } = await supabase
                .from('votes')
                .select('end_time')
                .eq('id', voteId)
                .single();

            if (voteData.end_time && isVoteExpired(voteData.end_time)) {
                alert('íˆ¬í‘œ ê¸°ê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadVotes();
                return;
            }

            const selectedOption = document.querySelector(`#options_${voteId} .vote-option.selected`);
            if (!selectedOption) {
                alert('ì„ íƒì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const optionIdx = Array.from(selectedOption.parentNode.children).indexOf(selectedOption);

            try {
                // ì¤‘ë³µ íˆ¬í‘œ í™•ì¸
                const { data: existingVote } = await supabase
                    .from('vote_results')
                    .select('*')
                    .eq('vote_id', voteId)
                    .eq('user_id', currentUser.id);

                if (existingVote && existingVote.length > 0) {
                    alert('ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤.');
                    return;
                }

                // íˆ¬í‘œ ì €ì¥
                const { error } = await supabase
                    .from('vote_results')
                    .insert({
                        vote_id: voteId,
                        user_id: currentUser.id,
                        user_name: currentUser.name,
                        option: optionIdx
                    });

                if (error) throw error;

                alert('íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                selectedOption.classList.remove('selected');
            } catch (error) {
                console.error('íˆ¬í‘œ ì‹¤íŒ¨:', error);
                alert('íˆ¬í‘œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // íˆ¬í‘œ ìƒì„± ëª¨ë‹¬
        function openVoteCreateModal() {
            // ê¸°ë³¸ ì¢…ë£Œ ì‹œê°„ì„ í˜„ì¬ ì‹œê°„ + 1ì¼ë¡œ ì„¤ì •
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateStr = tomorrow.toISOString().split('T')[0];
            const timeStr = '23:59';
            
            document.getElementById('voteEndDate').value = dateStr;
            document.getElementById('voteEndTime').value = timeStr;
            document.getElementById('voteCreateModal').style.display = 'flex';
        }

        async function createVote() {
            const type = document.getElementById('voteType').value;
            const title = document.getElementById('voteTitle').value.trim();
            const optionsText = document.getElementById('voteOptions').value.trim();
            const endDate = document.getElementById('voteEndDate').value;
            const endTime = document.getElementById('voteEndTime').value;

            if (!title || !optionsText) {
                document.getElementById('createVoteError').textContent = 'ì œëª©ê³¼ ì„ íƒì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }

            if (!endDate || !endTime) {
                document.getElementById('createVoteError').textContent = 'íˆ¬í‘œ ì¢…ë£Œ ë‚ ì§œì™€ ì‹œê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.';
                return;
            }

            const endDateTime = new Date(`${endDate}T${endTime}`);
            if (endDateTime <= new Date()) {
                document.getElementById('createVoteError').textContent = 'ì¢…ë£Œ ì‹œê°„ì€ í˜„ì¬ ì‹œê°„ë³´ë‹¤ ë‚˜ì¤‘ì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                return;
            }

            if (containsBadWords(title + optionsText)) {
                document.getElementById('createVoteError').textContent = 'ë¶€ì ì ˆí•œ ë‚´ìš©ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';
                return;
            }

            const options = optionsText.split('\n').filter(opt => opt.trim());
            if (options.length < 2) {
                document.getElementById('createVoteError').textContent = 'ìµœì†Œ 2ê°œì˜ ì„ íƒì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.';
                return;
            }

            try {
                const { error } = await supabase
                    .from('votes')
                    .insert({
                        type: type,
                        title: title,
                        options: options,
                        created_by: currentUser.id,
                        is_completed: false,
                        end_time: endDateTime.toISOString()
                    });

                if (error) throw error;

                closeModal('voteCreateModal');
                document.getElementById('voteTitle').value = '';
                document.getElementById('voteOptions').value = '';
                document.getElementById('createVoteError').textContent = '';
                loadVotes();
                alert('íˆ¬í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('íˆ¬í‘œ ìƒì„± ì‹¤íŒ¨:', error);
                document.getElementById('createVoteError').textContent = 'íˆ¬í‘œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
        }

        // íˆ¬í‘œ ì‚­ì œ
        async function deleteVote(voteId) {
            if (!confirm('ì •ë§ë¡œ ì´ íˆ¬í‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\níˆ¬í‘œ ê²°ê³¼ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) return;

            try {
                await supabase.from('vote_results').delete().eq('vote_id', voteId);
                await supabase.from('votes').delete().eq('id', voteId);
                
                // íƒ€ì´ë¨¸ ì •ë¦¬
                if (countdownTimers[voteId]) {
                    clearInterval(countdownTimers[voteId]);
                    delete countdownTimers[voteId];
                }
                
                loadVotes();
                loadCompletedVotes();
                alert('íˆ¬í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('íˆ¬í‘œ ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // íˆ¬í‘œ ì™„ë£Œ
        async function completeVote(voteId) {
            if (!confirm('ì´ íˆ¬í‘œë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const { data: results } = await supabase
                    .from('vote_results')
                    .select('*')
                    .eq('vote_id', voteId);

                await supabase
                    .from('votes')
                    .update({ 
                        is_completed: true, 
                        completed_at: new Date().toISOString(),
                        results: results 
                    })
                    .eq('id', voteId);

                // íƒ€ì´ë¨¸ ì •ë¦¬
                if (countdownTimers[voteId]) {
                    clearInterval(countdownTimers[voteId]);
                    delete countdownTimers[voteId];
                }

                loadVotes();
                loadCompletedVotes();
                alert('íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('íˆ¬í‘œ ì™„ë£Œ ì‹¤íŒ¨:', error);
                alert('ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê±´ì˜ì‚¬í•­
        function openSuggestionModal() {
            document.getElementById('suggestionModal').style.display = 'flex';
        }

        function selectProfile(color) {
            selectedProfileColor = color;
            document.getElementById('selectedProfile').value = color;
            
            // ì„ íƒëœ í”„ë¡œí•„ í‘œì‹œ
            document.querySelectorAll('.profile-circle').forEach(circle => {
                circle.style.border = circle.style.backgroundColor === color ? '3px solid #333' : 'none';
            });
        }

        async function submitSuggestion() {
            const content = document.getElementById('suggestionContent').value.trim();
            
            if (!content) {
                document.getElementById('suggestionError').textContent = 'ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }

            if (containsBadWords(content)) {
                document.getElementById('suggestionError').textContent = 'ë¶€ì ì ˆí•œ ë‚´ìš©ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';
                return;
            }

            try {
                const { error } = await supabase
                    .from('suggestions')
                    .insert({
                        user_id: currentUser.id,
                        user_name: currentUser.name,
                        user_grade: currentUser.grade,
                        user_class: currentUser.class,
                        content: content,
                        profile_color: selectedProfileColor
                    });

                if (error) throw error;

                closeModal('suggestionModal');
                document.getElementById('suggestionContent').value = '';
                document.getElementById('suggestionError').textContent = '';
                loadPublicSuggestions();
                alert('ê±´ì˜ì‚¬í•­ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ê±´ì˜ì‚¬í•­ ì œì¶œ ì‹¤íŒ¨:', error);
                document.getElementById('suggestionError').textContent = 'ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
        }

        // ê³µê°œ ê±´ì˜ì‚¬í•­ ë¡œë“œ (ë©”ì¸ í˜ì´ì§€ìš©)
        async function loadPublicSuggestions() {
            try {
                console.log('ê³µê°œ ê±´ì˜ì‚¬í•­ ë¡œë”© ì‹œì‘...');
                
                const { data: suggestions, error } = await supabase
                    .from('suggestions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) {
                    console.error('ê±´ì˜ì‚¬í•­ ë¡œë“œ ì—ëŸ¬:', error);
                    throw error;
                }

                console.log('ë¡œë“œëœ ê±´ì˜ì‚¬í•­:', suggestions);

                const suggestionsList = document.getElementById('publicSuggestionsList');
                if (!suggestions || suggestions.length === 0) {
                    suggestionsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">ì•„ì§ ê±´ì˜ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ê±´ì˜ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</p>';
                } else {
                    suggestionsList.innerHTML = suggestions.map(suggestion => `
                        <div class="suggestion-item">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <div class="profile-circle" style="background: ${suggestion.profile_color};">
                                    ${suggestion.user_name ? suggestion.user_name[0] : '?'}
                                </div>
                                <div>
                                    <strong>${suggestion.user_grade}í•™ë…„ ${suggestion.user_class}ë°˜ ${suggestion.user_name}</strong>
                                    <br><small>${new Date(suggestion.created_at).toLocaleString('ko-KR')}</small>
                                </div>
                            </div>
                            <p>${suggestion.content}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('ê³µê°œ ê±´ì˜ì‚¬í•­ ë¡œë“œ ì‹¤íŒ¨:', error);
                const suggestionsList = document.getElementById('publicSuggestionsList');
                suggestionsList.innerHTML = `
                    <p style="text-align: center; color: #e74c3c; padding: 20px;">
                        ê±´ì˜ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>
                        <small>ì˜¤ë¥˜: ${error.message}</small>
                    </p>
                `;
            }
        }

        // ê±´ì˜ì‚¬í•­ ë³´ê¸° (ì¼ë°˜ ì‚¬ìš©ììš©)
        async function viewAllSuggestions() {
            // ë¡œë”© í‘œì‹œ
            const suggestionsList = document.getElementById('publicSuggestionsModalList');
            suggestionsList.innerHTML = '<p>ê±´ì˜ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
            
            // ëª¨ë‹¬ ë¨¼ì € í‘œì‹œ
            document.getElementById('publicSuggestionsModal').style.display = 'flex';
            
            try {
                // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ëª¨ë“  ê±´ì˜ì‚¬í•­ ê°€ì ¸ì˜¤ê¸°
                const { data: suggestions, error } = await supabase
                    .from('suggestions')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    throw error;
                }

                if (!suggestions || suggestions.length === 0) {
                    suggestionsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">ì•„ì§ ê±´ì˜ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    suggestionsList.innerHTML = suggestions.map(suggestion => `
                        <div class="suggestion-item">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <div class="profile-circle" style="background: ${suggestion.profile_color};">
                                    ${suggestion.user_name ? suggestion.user_name[0] : '?'}
                                </div>
                                <div>
                                    <strong>${suggestion.user_grade}í•™ë…„ ${suggestion.user_class}ë°˜ ${suggestion.user_name}</strong>
                                    <br><small>${new Date(suggestion.created_at).toLocaleString('ko-KR')}</small>
                                </div>
                            </div>
                            <p>${suggestion.content}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('ê±´ì˜ì‚¬í•­ ë¡œë“œ ì‹¤íŒ¨:', error);
                suggestionsList.innerHTML = `
                    <p style="text-align: center; color: #e74c3c; padding: 20px;">
                        ê±´ì˜ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>
                        <small>ì˜¤ë¥˜: ${error.message}</small><br>
                        <button class="btn btn-small" onclick="viewAllSuggestions()" style="margin-top: 10px;">ë‹¤ì‹œ ì‹œë„</button>
                    </p>
                `;
            }
        }

        // ê±´ì˜ì‚¬í•­ ê´€ë¦¬ (ê´€ë¦¬ììš©)
        async function viewSuggestions() {
            try {
                const { data: suggestions } = await supabase
                    .from('suggestions')
                    .select('*')
                    .order('created_at', { ascending: false });

                const suggestionsList = document.getElementById('suggestionsList');
                if (!suggestions || suggestions.length === 0) {
                    suggestionsList.innerHTML = '<p>ê±´ì˜ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    suggestionsList.innerHTML = suggestions.map(suggestion => `
                        <div class="suggestion-item">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <div class="profile-circle" style="background: ${suggestion.profile_color};">
                                    ${suggestion.user_name[0]}
                                </div>
                                <div>
                                    <strong>${suggestion.user_grade}í•™ë…„ ${suggestion.user_class}ë°˜ ${suggestion.user_name}</strong>
                                    <br><small>${new Date(suggestion.created_at).toLocaleString()}</small>
                                </div>
                                <button class="btn btn-danger btn-small" onclick="deleteSuggestion(${suggestion.id})" style="margin-left: auto;">ì‚­ì œ</button>
                            </div>
                            <p>${suggestion.content}</p>
                        </div>
                    `).join('');
                }

                document.getElementById('suggestionsViewModal').style.display = 'flex';
            } catch (error) {
                console.error('ê±´ì˜ì‚¬í•­ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        async function deleteSuggestion(suggestionId) {
            if (!confirm('ì´ ê±´ì˜ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                await supabase.from('suggestions').delete().eq('id', suggestionId);
                viewSuggestions(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadPublicSuggestions(); // ë©”ì¸ í˜ì´ì§€ë„ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                console.error('ê±´ì˜ì‚¬í•­ ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë‹¬ ê´€ë¦¬
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œì‹œ íƒ€ì´ë¨¸ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            Object.values(countdownTimers).forEach(timer => clearInterval(timer));
        });

        // ì´ˆê¸° í”„ë¡œí•„ ìƒ‰ìƒ ì„¤ì •
        selectProfile('#3498db');
    </script>
</body>
</html>
