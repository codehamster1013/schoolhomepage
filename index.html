<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서울명덕초등학교</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Gun.js CDN for real-time data synchronization -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        /* 기존 CSS 스타일은 변경 없이 유지 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: '맑은 고딕', sans-serif; background: #f4f7f6; color: #333; line-height: 1.6; }
        .container { max-width: 1000px; margin: 20px auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .header { display: flex; align-items: center; justify-content: space-between; padding-bottom: 20px; border-bottom: 1px solid #eee; margin-bottom: 30px; }
        .header-left { display: flex; align-items: center; }
        .logo { width: 60px; height: 60px; border-radius: 50%; overflow: hidden; margin-right: 15px; border: 3px solid #62C18F; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .logo img { width: 100%; height: 100%; object-fit: cover; }
        .school-name { font-size: 28px; font-weight: bold; color: #333; text-shadow: 1px 1px 2px rgba(0,0,0,0.05); }
        .nav { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; justify-content: flex-start; }
        .btn { padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s ease; }
        .btn-primary { background: #62C18F; color: white; box-shadow: 0 4px 8px rgba(98, 193, 143, 0.3); }
        .btn-primary:hover { background: #4CAF80; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(98, 193, 143, 0.4); }
        .btn-secondary { background: #e0e0e0; color: #555; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-secondary:hover { background: #d0d0d0; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn-danger { background: #ff4444; color: white; }
        .btn-danger:hover { background: #cc0000; transform: translateY(-2px); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 40px; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); text-align: center; position: relative; }
        .modal h2 { margin-bottom: 25px; color: #333; font-size: 26px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; font-size: 15px; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus { border-color: #62C18F; outline: none; box-shadow: 0 0 0 3px rgba(98, 193, 143, 0.2); }
        textarea { resize: vertical; min-height: 80px; }
        .close { position: absolute; top: 15px; right: 20px; font-size: 32px; color: #aaa; cursor: pointer; transition: color 0.3s; }
        .close:hover { color: #555; }

        .section-card { background: #ffffff; padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.06); }
        .section-card h3 { font-size: 22px; color: #333; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        
        .comment-section { margin-top: 40px; }
        .comment { background: #f9f9f9; padding: 15px 20px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #eee; transition: all 0.3s ease; }
        .comment:hover { background: #f5f5f5; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .comment-author { font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; color: #444; font-size: 15px; }
        .profile { width: 34px; height: 34px; background: #62C18F; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: white; font-size: 16px; font-weight: bold; margin-right: 12px; flex-shrink: 0; }
        .comment-text { font-size: 16px; color: #333; word-wrap: break-word; }
        .comment-meta { font-size: 12px; color: #888; margin-top: 5px; display: flex; justify-content: space-between; align-items: center; }
        .comment-meta button { background: none; border: none; color: #ff6666; font-size: 12px; cursor: pointer; padding: 0 5px; transition: color 0.3s; }
        .comment-meta button:hover { color: #cc0000; }
        .comment-options { display: flex; justify-content: flex-end; align-items: center; gap: 8px; }
        
        .login-section, .comment-input-section { margin-top: 30px; padding: 20px; background: #f0f8ff; border-radius: 10px; border: 1px solid #e0efff; }
        .login-section h3, .comment-input-section h3 { margin-bottom: 15px; color: #0056b3; }
        .login-info { margin-top: 15px; font-weight: bold; color: #28a745; }
        .error-message { color: #dc3545; margin-top: 10px; font-size: 14px; }


        .vote-section { margin: 30px 0; padding: 30px; border: 1px solid #ddd; } /* 잘린 스타일 마저 추가 */
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <div class="logo"><img src="https://via.placeholder.com/60" alt="로고"></div>
                <h1 class="school-name">서울명덕초등학교</h1>
            </div>
            <!-- 기타 헤더 요소 -->
        </header>

        <nav class="nav">
            <button class="btn btn-primary">학교 소개</button>
            <button class="btn btn-secondary">학교 생활</button>
            <button class="btn btn-secondary">교육 활동</button>
            <button class="btn btn-secondary">열린 마당</button>
            <button class="btn btn-secondary">공지사항</button>
        </nav>

        <section class="section-card login-section">
            <h3>로그인 / 회원가입 (Gun.js User)</h3>
            <div class="form-group">
                <label for="username">사용자 이름:</label>
                <input type="text" id="username" placeholder="사용자 이름 입력">
            </div>
            <div class="form-group">
                <label for="password">비밀번호:</label>
                <input type="password" id="password" placeholder="비밀번호 입력">
            </div>
            <div class="form-group">
                <label for="isAdminUser">관리자 계정인가요? (가입시 선택):</label>
                <input type="checkbox" id="isAdminUser">
            </div>
            <button class="btn btn-primary" onclick="signUp()">회원가입</button>
            <button class="btn btn-secondary" onclick="login()">로그인</button>
            <button class="btn btn-danger" onclick="logout()">로그아웃</button>
            <div id="loginStatus" class="login-info"></div>
            <div id="loginError" class="error-message"></div>
        </section>

        <section class="section-card comment-input-section">
            <h3>건의함 (댓글)</h3>
            <div class="form-group">
                <label for="commentAuthor">작성자:</label>
                <input type="text" id="commentAuthor" placeholder="작성자 이름" maxlength="20">
            </div>
            <div class="form-group">
                <label for="commentContent">내용 (<span id="commentCharCount">0</span>/150자):</label>
                <textarea id="commentContent" placeholder="여기에 건의사항을 작성해주세요..." maxlength="150"></textarea>
                <div id="commentError" class="error-message"></div>
            </div>
            <button class="btn btn-primary" onclick="addComment()">건의하기</button>
            <div id="lastCommentTime" style="font-size: 12px; color: #888; margin-top: 5px;"></div>
        </section>

        <section class="section-card comment-section">
            <h3>최신 건의사항 (총 <span id="commentCount">0</span>개)</h3>
            <div id="commentsList">
                <!-- 댓글들이 여기에 실시간으로 추가됩니다. -->
            </div>
        </section>
    </div>

    <script>
        // Gun.js 인스턴스 초기화
        // P2P 연결을 위해 릴레이 서버를 지정할 수 있습니다. (예: ['https://gun-peers.herokuapp.com/gun'])
        // 여기서는 기본 로컬 스토리지를 사용합니다.
        const db = Gun();
        const user = db.user(); // Gun.js 사용자 인스턴스
        let currentUserIsHost = false; // 현재 로그인한 사용자가 관리자인지 여부
        let lastCommentTimestamp = 0; // 도배 방지를 위한 마지막 댓글 작성 시간

        // DOM 요소 가져오기
        const commentsList = document.getElementById('commentsList');
        const commentAuthorInput = document.getElementById('commentAuthor');
        const commentContentInput = document.getElementById('commentContent');
        const commentCharCount = document.getElementById('commentCharCount');
        const commentErrorDiv = document.getElementById('commentError');
        const loginStatusDiv = document.getElementById('loginStatus');
        const loginErrorDiv = document.getElementById('loginError');
        const commentCountSpan = document.getElementById('commentCount');
        const lastCommentTimeDiv = document.getElementById('lastCommentTime');

        // --- 사용자 인증 (로그인/회원가입) 관련 기능 ---

        // 현재 로그인 상태 확인 및 isHost 값 로드
        user.recall({ sessionStorage: true }).on(ack => {
            if (ack.err) {
                console.warn("로그인 정보 로드 실패:", ack.err);
                loginStatusDiv.textContent = '로그아웃 상태입니다.';
                currentUserIsHost = false;
            } else if (ack.pub) {
                user.get('profile').get('isAdmin').on(isAdmin => {
                    currentUserIsHost = isAdmin === true;
                    loginStatusDiv.textContent = `환영합니다, ${ack.alias}! 당신은 ${currentUserIsHost ? '관리자' : '일반 사용자'}입니다.`;
                    console.log("현재 사용자 isHost:", currentUserIsHost);
                });
            } else {
                loginStatusDiv.textContent = '로그아웃 상태입니다.';
                currentUserIsHost = false;
            }
            updateCommentSectionVisibility(); // 로그인 상태에 따라 댓글 입력/삭제 버튼 표시 여부 업데이트
        });

        function signUp() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const isAdmin = document.getElementById('isAdminUser').checked;
            loginErrorDiv.textContent = ''; // 에러 메시지 초기화

            if (!username || !password) {
                loginErrorDiv.textContent = '사용자 이름과 비밀번호를 모두 입력해주세요.';
                return;
            }

            user.create(username, password, ack => {
                if (ack.err) {
                    loginErrorDiv.textContent = `회원가입 실패: ${ack.err}`;
                } else {
                    alert('회원가입 성공!');
                    // 프로필 정보에 isAdmin 저장
                    user.get('profile').put({ alias: username, isAdmin: isAdmin });
                    // 바로 로그인 시도
                    user.auth(username, password, authAck => {
                        if (authAck.err) {
                            loginErrorDiv.textContent = `회원가입 후 자동 로그인 실패: ${authAck.err}`;
                        } else {
                            loginStatusDiv.textContent = `환영합니다, ${username}! 당신은 ${isAdmin ? '관리자' : '일반 사용자'}입니다.`;
                            currentUserIsHost = isAdmin;
                            updateCommentSectionVisibility();
                        }
                    });
                }
            });
        }

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            loginErrorDiv.textContent = ''; // 에러 메시지 초기화

            if (!username || !password) {
                loginErrorDiv.textContent = '사용자 이름과 비밀번호를 모두 입력해주세요.';
                return;
            }

            user.auth(username, password, ack => {
                if (ack.err) {
                    loginErrorDiv.textContent = `로그인 실패: ${ack.err}`;
                } else {
                    user.get('profile').get('isAdmin').on(isAdmin => {
                        currentUserIsHost = isAdmin === true; // isAdmin이 없으면 false
                        loginStatusDiv.textContent = `환영합니다, ${username}! 당신은 ${currentUserIsHost ? '관리자' : '일반 사용자'}입니다.`;
                        updateCommentSectionVisibility();
                    });
                }
            });
        }

        function logout() {
            user.leave();
            currentUserIsHost = false;
            loginStatusDiv.textContent = '로그아웃 되었습니다.';
            loginErrorDiv.textContent = '';
            updateCommentSectionVisibility();
            console.log("로그아웃 완료");
        }
        
        // --- 댓글 기능 ---

        // 댓글 입력창 글자 수 카운트
        commentContentInput.addEventListener('input', () => {
            commentCharCount.textContent = commentContentInput.value.length;
        });

        // 댓글 추가 함수
        function addComment() {
            const author = commentAuthorInput.value.trim();
            const content = commentContentInput.value.trim();
            const now = Date.now();
            commentErrorDiv.textContent = '';

            // 도배 방지: 최소 5초 간격
            const MIN_COMMENT_INTERVAL = 5 * 1000; // 5초
            if (now - lastCommentTimestamp < MIN_COMMENT_INTERVAL) {
                commentErrorDiv.textContent = `도배 방지를 위해 잠시 후 다시 작성해주세요 (${Math.ceil((MIN_COMMENT_INTERVAL - (now - lastCommentTimestamp)) / 1000)}초 남음).`;
                return;
            }

            if (!author || !content) {
                commentErrorDiv.textContent = '작성자와 내용을 모두 입력해주세요.';
                return;
            }

            if (content.length > 150) { // 최대 입력 글자 수 제한 (maxlength는 HTML에서 이미 설정)
                commentErrorDiv.textContent = '댓글은 150자 이내로 작성해주세요.';
                return;
            }
            
            // Gun.js를 통한 댓글 저장
            const commentId = Gun.SEA.pair().pub; // 각 댓글에 고유 ID 부여 (임시로 pub key 사용)
            const commentData = {
                id: commentId,
                author: author,
                content: content,
                timestamp: now,
                owner: user.is && user.is.pub ? user.is.pub : null // 로그인한 사용자가 있다면 소유자 ID 저장
            };

            // 'comments' 컬렉션에 댓글 추가
            db.get('comments').get(commentId).put(commentData, ack => {
                if (ack.err) {
                    commentErrorDiv.textContent = `댓글 저장 실패: ${ack.err}`;
                    console.error("댓글 저장 에러:", ack.err);
                } else {
                    commentAuthorInput.value = '';
                    commentContentInput.value = '';
                    commentCharCount.textContent = '0';
                    lastCommentTimestamp = now;
                    lastCommentTimeDiv.textContent = `마지막 댓글 작성: ${new Date(now).toLocaleTimeString()}`;
                    console.log('댓글이 성공적으로 추가되었습니다:', commentData);
                }
            });
        }

        // 댓글 삭제 함수
        // Gun.js에서는 특정 노드를 'null'로 설정하면 삭제됩니다.
        function deleteComment(commentId, commentOwnerPub) {
            if (!user.is) { // 로그인 여부 확인
                alert('로그인 후 이용해주세요.');
                return;
            }
            
            // P2P 환경에서는 보안 로직이 중요합니다.
            // 여기서는 currentUserIsHost 변수를 사용해 UI에서 삭제 버튼을 제어하지만,
            // 실제 데이터 삭제 권한은 Gun.js의 'owner' 개념과 연동하는 것이 좋습니다.
            // 기본 Gun.js에서는 본인이 생성한 데이터만 삭제 가능하도록 되어 있습니다.
            // 관리자가 타인의 댓글을 삭제하려면, Gun.js 'ACL' (Access Control List) 또는
            // 'trust chain'과 같은 더 심화된 개념이 필요합니다.
            // 여기서는 일단 'currentUserIsHost'가 true이면 삭제를 시도하도록 합니다.
            // (주의: 이는 클라이언트 측 검증에 가까우며, 숙련된 사용자는 우회할 수 있습니다.)
            if (!currentUserIsHost) {
                alert('관리자만 댓글을 삭제할 수 있습니다.');
                return;
            }
            
            if (confirm('이 댓글을 정말로 삭제하시겠습니까?')) {
                // 특정 댓글 ID를 가진 노드를 찾아 null로 설정 (삭제)
                db.get('comments').get(commentId).put(null, ack => {
                    if (ack.err) {
                        alert(`댓글 삭제 실패: ${ack.err}`);
                        console.error("댓글 삭제 에러:", ack.err);
                    } else {
                        console.log('댓글이 성공적으로 삭제되었습니다:', commentId);
                    }
                });
            }
        }
        
        // --- 댓글 목록 실시간 렌더링 및 자동 삭제 로직 ---

        let allComments = {}; // 모든 댓글 데이터를 저장할 객체
        const MAX_COMMENTS = 7; // 최대 댓글 개수

        function renderComments() {
            const sortedComments = Object.values(allComments)
                                       .filter(comment => comment && comment.timestamp) // 유효하고 timestamp 있는 댓글만 필터
                                       .sort((a, b) => b.timestamp - a.timestamp); // 최신 댓글부터 정렬 (내림차순)

            commentCountSpan.textContent = sortedComments.length;
            commentsList.innerHTML = ''; // 기존 목록 비우기

            const commentsToDisplay = sortedComments.slice(0, MAX_COMMENTS); // 최대 7개만 표시

            commentsToDisplay.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.classList.add('comment');
                commentElement.setAttribute('data-comment-id', comment.id);

                const profileInitial = comment.author ? comment.author[0] : '?';
                const deleteButtonHtml = currentUserIsHost 
                    ? `<button onclick="deleteComment('${comment.id}', '${comment.owner}')">삭제</button>` 
                    : '';

                commentElement.innerHTML = `
                    <div class="comment-author">
                        <span class="profile">${profileInitial}</span>
                        ${comment.author}
                    </div>
                    <p class="comment-text">${comment.content}</p>
                    <div class="comment-meta">
                        <span>${new Date(comment.timestamp).toLocaleString()}</span>
                        <div class="comment-options">${deleteButtonHtml}</div>
                    </div>
                `;
                commentsList.appendChild(commentElement);
            });

            // 7개를 초과하는 오래된 댓글 자동 삭제 로직 (Gun.js)
            // 주의: 이 로직은 각 클라이언트에서 개별적으로 실행되며,
            // P2P 환경에서 모든 노드가 완벽히 동기화되기까지 시간이 걸릴 수 있습니다.
            // 더 강력한 중앙 관리 (예: 신뢰할 수 있는 릴레이 서버) 없이는 '확실한' 삭제를 보장하기 어려울 수 있습니다.
            if (sortedComments.length > MAX_COMMENTS) {
                const commentsToDelete = sortedComments.slice(MAX_COMMENTS); // 7개를 초과하는 오래된 댓글
                commentsToDelete.forEach(comment => {
                    console.log(`오래된 댓글 자동 삭제 시도: ${comment.id}`);
                    db.get('comments').get(comment.id).put(null, ack => {
                        if (ack.err) {
                            console.error(`자동 삭제 실패 (${comment.id}): ${ack.err}`);
                        } else {
                            console.log(`자동 삭제 성공 (${comment.id})`);
                        }
                    });
                });
            }
        }

        // Gun.js를 통해 'comments' 노드의 모든 변경 사항 실시간으로 감지
        db.get('comments').map().on((comment, id) => {
            if (comment) { // 댓글이 존재하면 추가/업데이트
                allComments[id] = comment;
            } else { // 댓글이 null로 설정되면 (삭제되면) allComments에서 제거
                delete allComments[id];
            }
            renderComments(); // 변경된 데이터를 기반으로 댓글 목록 다시 그리기
        });

        // --- 기타 UI 업데이트 함수 ---

        // 로그인 상태에 따라 댓글 관련 섹션의 가시성을 업데이트 (예: 관리자 삭제 버튼)
        function updateCommentSectionVisibility() {
            const commentElements = commentsList.querySelectorAll('.comment');
            commentElements.forEach(commentEl => {
                const deleteButton = commentEl.querySelector('.comment-options button');
                if (deleteButton) {
                    deleteButton.style.display = currentUserIsHost ? 'inline-block' : 'none';
                }
            });

            // 작성자 입력창에 현재 로그인 사용자 이름 자동 채우기 (로그인 시)
            if (user.is && user.is.alias) {
                commentAuthorInput.value = user.is.alias;
                commentAuthorInput.readOnly = true; // 로그인 시 작성자 이름 수정 불가
            } else {
                commentAuthorInput.value = '';
                commentAuthorInput.readOnly = false;
            }
        }

        // 초기 로드 시 댓글 목록 렌더링 및 UI 업데이트
        renderComments(); // 초기화 시 한 번 호출
        updateCommentSectionVisibility(); // 초기화 시 로그인 상태 반영
    </script>
</body>
</html>
