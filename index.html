<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서울명덕초등학교</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: '맑은 고딕', sans-serif; background: #f5f7fa; line-height: 1.6; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-left { text-align: left; }
        .header-right { }
        .header h1 { margin-bottom: 5px; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .login-card, .main-card { background: white; border-radius: 12px; padding: 30px; margin: 20px 0; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; }
        input:focus, select:focus, textarea:focus { border-color: #667eea; outline: none; }
        .btn { background: #667eea; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: all 0.3s; }
        .btn:hover { background: #5a6fd8; transform: translateY(-2px); }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219a52; }
        .btn-warning { background: #f39c12; }
        .btn-warning:hover { background: #d68910; }
        .btn-small { padding: 8px 16px; font-size: 14px; }
        .btn-header { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; font-size: 14px; }
        .btn-header:hover { background: rgba(255,255,255,0.3); transform: none; }
        .vote-item { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin: 15px 0; position: relative; }
        .vote-item.active { border-color: #667eea; background: #f0f3ff; }
        .chart-container { 
            position: relative; 
            width: 100%; 
            height: 300px; 
            margin: 20px 0;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        .chart-wrapper {
            position: relative;
            height: 280px;
            width: 100%;
        }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .close { float: right; font-size: 24px; cursor: pointer; color: #999; }
        .close:hover { color: #333; }
        .suggestion-item { background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 4px solid #667eea; }
        .profile-circle { width: 40px; height: 40px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 10px; }
        .user-info { background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .vote-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .vote-option { background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .vote-option:hover { border-color: #667eea; background: #f0f3ff; }
        .vote-option.selected { border-color: #667eea; background: #667eea; color: white; }
        .admin-panel { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .hidden { display: none; }
        .error { color: #e74c3c; font-size: 14px; margin-top: 5px; }
        .success { color: #27ae60; font-size: 14px; margin-top: 5px; }
        .admin-hint { background: #e8f5e8; border: 1px solid #c3e6c3; border-radius: 6px; padding: 10px; margin-top: 10px; font-size: 14px; color: #2d5016; }
        .public-suggestions { background: white; border-radius: 12px; padding: 20px; margin: 20px 0; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: relative; }
        .suggestions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>🏫 서울명덕초등학교</h1>
            <p>학급 투표 및 건의 시스템</p>
        </div>
        <div class="header-right">
            <button id="loadDataBtn" class="btn btn-header hidden" onclick="loadAllData()">🔃</button>
        </div>
    </div>

    <!-- 로그인 화면 -->
    <div id="loginScreen" class="container">
        <div class="login-card">
            <h2>학생 정보 입력</h2>
            <div class="form-group">
                <label>학년</label>
                <select id="grade">
                    <option value="">선택하세요</option>
                    <option value="1">1학년</option>
                    <option value="2">2학년</option>
                    <option value="3">3학년</option>
                    <option value="4">4학년</option>
                    <option value="5">5학년</option>
                    <option value="6">6학년</option>
                </select>
            </div>
            <div class="form-group">
                <label>반</label>
                <select id="class">
                    <option value="">선택하세요</option>
                    <option value="1">1반</option><option value="2">2반</option><option value="3">3반</option><option value="4">4반</option><option value="5">5반</option>
                    <option value="6">6반</option><option value="7">7반</option><option value="8">8반</option><option value="9">9반</option><option value="10">10반</option><option value="11">11반</option>
                </select>
            </div>
            <div class="form-group">
                <label>번호</label>
                <input type="text" id="lastName" placeholder="번호를 입력하세요" maxlength="10">
            </div>
            <div class="form-group">
                <label>이름</label>
                <input type="text" id="firstName" placeholder="이름을 입력하세요" maxlength="10">
                <label>입장하기</label>
            </div>
            <button class="btn" onclick="login()">입장하기</button>
            <div id="loginError" class="error"></div>
        </div>
    </div>

    <!-- 메인 화면 -->
    <div id="mainScreen" class="hidden">
        <div class="container">
            <div id="userInfo" class="user-info"></div>

            <!-- 관리자 패널 -->
            <div id="adminPanel" class="admin-panel hidden">
                <h3>🔧 관리자 패널</h3>
                <button class="btn btn-small" onclick="openVoteCreateModal()">투표 만들기</button>
                <button class="btn btn-danger btn-small" onclick="viewSuggestions()">건의사항 관리</button>
            </div>

            <!-- 투표 목록 -->
            <div class="main-card">
                <h2>📊 현재 진행중인 투표</h2>
                <div id="votesList"></div>
            </div>

            <!-- 완료된 투표 결과 -->
            <div class="main-card">
                <h2>📈 투표 결과</h2>
                <div id="completedVotes"></div>
            </div>

            <!-- 건의사항은 관리자만 볼 수 있음 -->
            <div id="suggestionSection" class="public-suggestions hidden">
                <div class="suggestions-header">
                    <h2>💬 건의사항</h2>
                    <button class="btn btn-small" onclick="openSuggestionModal()">✍️ 건의하기</button>
                </div>
                <div id="publicSuggestionsList"></div>
            </div>

            <!-- 일반 학생용 건의하기 버튼 -->
            <div id="studentSuggestionButton" class="main-card">
                <h2>💬 건의하기</h2>
                <p style="margin-bottom: 15px;">학급이나 학교에 대한 의견이나 건의사항이 있다면 알려주세요!</p>
                <button class="btn" onclick="openSuggestionModal()">✍️ 건의하기</button>
            </div>
        </div>
    </div>

    <!-- 투표 생성 모달 -->
    <div id="voteCreateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('voteCreateModal')">&times;</span>
            <h3>새 투표 만들기</h3>
            <div class="form-group">
                <label>투표 유형</label>
                <select id="voteType">
                    <option value="meal">급식 투표</option>
                    <option value="music">음악방송 투표</option>
                    <option value="event">학급행사 투표</option>
                </select>
            </div>
            <div class="form-group">
                <label>제목</label>
                <input type="text" id="voteTitle" placeholder="투표 제목을 입력하세요">
            </div>
            <div class="form-group">
                <label>선택지 (각 줄에 하나씩)</label>
                <textarea id="voteOptions" rows="5" placeholder="선택지1&#10;선택지2&#10;선택지3"></textarea>
            </div>
            <button class="btn" onclick="createVote()">투표 생성</button>
            <div id="createVoteError" class="error"></div>
        </div>
    </div>

    <!-- 건의사항 모달 -->
    <div id="suggestionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('suggestionModal')">&times;</span>
            <h3>💬 건의하기</h3>
            <div class="form-group">
                <label>프로필 색상</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <div class="profile-circle" style="background: #e74c3c; cursor: pointer;" onclick="selectProfile('#e74c3c')">A</div>
                    <div class="profile-circle" style="background: #3498db; cursor: pointer;" onclick="selectProfile('#3498db')">B</div>
                    <div class="profile-circle" style="background: #2ecc71; cursor: pointer;" onclick="selectProfile('#2ecc71')">C</div>
                    <div class="profile-circle" style="background: #f39c12; cursor: pointer;" onclick="selectProfile('#f39c12')">D</div>
                    <div class="profile-circle" style="background: #9b59b6; cursor: pointer;" onclick="selectProfile('#9b59b6')">E</div>
                    <div class="profile-circle" style="background: #34495e; cursor: pointer;" onclick="selectProfile('#34495e')">F</div>
                </div>
                <input type="hidden" id="selectedProfile" value="#3498db">
            </div>
            <div class="form-group">
                <label>건의 내용</label>
                <textarea id="suggestionContent" rows="4" placeholder="건의사항을 작성해주세요..." maxlength="500"></textarea>
            </div>
            <button class="btn" onclick="submitSuggestion()">보내기</button>
            <div id="suggestionError" class="error"></div>
        </div>
    </div>

    <!-- 건의사항 관리 모달 (관리자용) -->
    <div id="suggestionsViewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('suggestionsViewModal')">&times;</span>
            <h3>📋 건의사항 관리</h3>
            <div id="suggestionsList"></div>
        </div>
    </div>

    <script>
        // Supabase 초기화 - 실제 프로젝트에서는 환경변수로 관리하세요
        const SUPABASE_URL = 'https://xyhdojgynscpjxlqnrul.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5aGRvamd5bnNjcGp4bHFucnVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMDI0MjAsImV4cCI6MjA3MDg3ODQyMH0.pGZzTeO_vbVIJioICKMyUIFUiHhKkTPOyDoM5QygcNw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let selectedProfileColor = '#3498db';
        let activeCharts = {}; // 차트 인스턴스 관리

        // 욕설 필터링
        const badWords = ['바보', '멍청이', '죽어', '꺼져', '시발', '병신', '개새끼', '씨발','시발', '시발점', '출발','섹션', '섹터', '지랄병','니애미', '어머니','애미','아버지','애비', '고자','고추'];
        
        function containsBadWords(text) {
            return badWords.some(word => text.toLowerCase().includes(word));
        }

        // 로그인
        function login() {
            const grade = document.getElementById('grade').value;
            const classNum = document.getElementById('class').value;
            const lastName = document.getElementById('lastName').value.trim();
            const firstName = document.getElementById('firstName').value.trim();

            if (!grade || !classNum || !lastName || !firstName) {
                document.getElementById('loginError').textContent = '모든 정보를 입력해주세요.';
                return;
            }

            if (containsBadWords(firstName)) {
                document.getElementById('loginError').textContent = '부적절한 이름입니다.';
                return;
            }

            // 관리자 인증: 이름이 서울명덕초등학교인 경우
            const isAdmin = (firstName === '서울명덕초등학교');

            currentUser = {
                grade: parseInt(grade),
                class: parseInt(classNum),
                name: lastName +'번 ' +firstName,
                isAdmin: isAdmin,
                id: `${grade}${classNum}_${lastName}${firstName}`
            };

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            document.getElementById('loadDataBtn').classList.remove('hidden');
            
            showUserInfo();
            if (isAdmin) {
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('suggestionSection').classList.remove('hidden');
                document.getElementById('studentSuggestionButton').classList.add('hidden');
            } else {
                document.getElementById('studentSuggestionButton').classList.remove('hidden');
            }
            
            loadAllData();
        }

        function showUserInfo() {
            const userInfo = `
                <strong>${currentUser.grade}학년 ${currentUser.class}반 ${currentUser.name}</strong>
                ${currentUser.isAdmin ? ' (관리자)' : ''}
            `;
            document.getElementById('userInfo').innerHTML = userInfo;
        }

        // 모든 데이터 불러오기
        function loadAllData() {
            loadVotes();
            loadCompletedVotes();
            if (currentUser.isAdmin) {
                loadPublicSuggestions();
            }
        }

        function getVoteTypeLabel(type) {
            const labels = {
                'meal': '급식투표',
                'music': '음악방송투표',
                'activity': '체험활동투표',
                'event': '학급행사투표',
                'other': '기타투표'
            };
            return labels[type] || '투표';
        }

        // 투표 로드
        async function loadVotes() {
            try {
                const { data: votes, error } = await supabase
                    .from('votes')
                    .select('*')
                    .eq('is_completed', false)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('투표 로드 에러:', error);
                    throw error;
                }

                const votesList = document.getElementById('votesList');
                if (!votes || votes.length === 0) {
                    votesList.innerHTML = '<p>진행중인 투표가 없습니다.</p>';
                    return;
                }

                votesList.innerHTML = votes.map(vote => {
                    return `
                        <div class="vote-item">
                            <h3>${vote.title}</h3>
                            <p><strong>${getVoteTypeLabel(vote.type)}</strong></p>
                            <div class="vote-options" id="options_${vote.id}">
                                ${vote.options.map((option, idx) => 
                                    `<div class="vote-option" onclick="selectOption(${vote.id}, ${idx})">${option}</div>`
                                ).join('')}
                            </div>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-small" onclick="vote(${vote.id})">투표하기</button>
                                ${currentUser.isAdmin ? `
                                    <button class="btn btn-danger btn-small" onclick="deleteVote(${vote.id})" style="margin-left: 10px;">삭제</button>
                                    <button class="btn btn-small" onclick="completeVote(${vote.id})" style="margin-left: 10px;">투표 완료</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('투표 로드 실패:', error);
                const votesList = document.getElementById('votesList');
                votesList.innerHTML = `<p style="color: #e74c3c;">투표를 불러오는데 실패했습니다: ${error.message}</p>`;
            }
        }

        // 완료된 투표 결과 로드
        async function loadCompletedVotes() {
            try {
                // 기존 차트 인스턴스 정리
                Object.values(activeCharts).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
                activeCharts = {};

                // 완료된 투표만 가져오기
                const { data: completedVotes, error: completedError } = await supabase
                    .from('votes')
                    .select('*')
                    .eq('is_completed', true)
                    .order('created_at', { ascending: false });

                if (completedError) {
                    console.error('완료된 투표 로드 에러:', completedError);
                    throw completedError;
                }

                const completedVotesDiv = document.getElementById('completedVotes');
                if (!completedVotes || completedVotes.length === 0) {
                    completedVotesDiv.innerHTML = '<p>완료된 투표가 없습니다.</p>';
                    return;
                }

                completedVotesDiv.innerHTML = completedVotes.map(vote => {
                    const chartId = `chart_${vote.id}`;
                    
                    return `
                        <div class="vote-item">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h3>${vote.title} (완료)</h3>
                                    <p><strong>${getVoteTypeLabel(vote.type)}</strong></p>
                                    
                                </div>
                                ${currentUser.isAdmin ? `
                                    <div>
                                        <button class="btn btn-warning btn-small" onclick="clearVoteResults(${vote.id})" style="margin-right: 10px;">결과 초기화</button>
                                        <button class="btn btn-danger btn-small" onclick="deleteVote(${vote.id})">삭제</button>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="chart-container">
                                <div class="chart-wrapper">
                                    <canvas id="${chartId}"></canvas>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // 차트 그리기
                setTimeout(() => {
                    completedVotes.forEach(vote => drawChart(vote));
                }, 100);
            } catch (error) {
                console.error('완료된 투표 로드 실패:', error);
                const completedVotesDiv = document.getElementById('completedVotes');
                completedVotesDiv.innerHTML = `<p style="color: #e74c3c;">완료된 투표를 불러오는데 실패했습니다: ${error.message}</p>`;
            }
        }

        async function drawChart(vote) {
            const ctx = document.getElementById(`chart_${vote.id}`);
            if (!ctx) return;

            try {
                // 실시간 투표 결과 가져오기
                const { data: results } = await supabase
                    .from('vote_results')
                    .select('*')
                    .eq('vote_id', vote.id);

                const labels = vote.options;
                const data = labels.map((_, idx) => results ? results.filter(r => r.option === idx).length : 0);
                const totalVotes = data.reduce((sum, count) => sum + count, 0);

                // 새 차트 인스턴스 생성
                activeCharts[vote.id] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '투표 수',
                            data: data,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            borderRadius: 6,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: `총 투표 수: ${totalVotes}명`,
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                color: '#333'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    color: '#666'
                                },
                                grid: {
                                    color: '#e9ecef'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#666',
                                    maxRotation: 45,
                                    minRotation: 0
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        layout: {
                            padding: {
                                top: 10,
                                bottom: 10,
                                left: 10,
                                right: 10
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('차트 그리기 실패:', error);
                ctx.parentElement.innerHTML = `<p style="color: #e74c3c; text-align: center;">차트를 불러오는데 실패했습니다.</p>`;
            }
        }

        // 투표 결과 초기화
        async function clearVoteResults(voteId) {
            if (!confirm('정말로 이 투표의 모든 결과를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) {
                return;
            }

            try {
                // 투표 결과 테이블에서 해당 투표의 모든 결과 삭제
                const { error } = await supabase
                    .from('vote_results')
                    .delete()
                    .eq('vote_id', voteId);

                if (error) throw error;

                // 투표 테이블의 results 필드도 null로 업데이트
                await supabase
                    .from('votes')
                    .update({ results: null })
                    .eq('id', voteId);

                alert('투표 결과가 초기화되었습니다.');
                loadCompletedVotes();
            } catch (error) {
                console.error('투표 결과 초기화 실패:', error);
                alert('투표 결과 초기화 중 오류가 발생했습니다.');
            }
        }

        // 투표 선택
        function selectOption(voteId, optionIdx) {
            const options = document.querySelectorAll(`#options_${voteId} .vote-option`);
            options.forEach((opt, idx) => {
                opt.classList.toggle('selected', idx === optionIdx);
            });
        }

        // 투표하기
        async function vote(voteId) {
            try {
                const selectedOption = document.querySelector(`#options_${voteId} .vote-option.selected`);
                if (!selectedOption) {
                    alert('선택지를 선택해주세요.');
                    return;
                }

                const optionIdx = Array.from(selectedOption.parentNode.children).indexOf(selectedOption);

                // 중복 투표 확인
                const { data: existingVote, error: checkError } = await supabase
                    .from('vote_results')
                    .select('*')
                    .eq('vote_id', voteId)
                    .eq('user_id', currentUser.id);

                if (checkError) {
                    console.error('중복 투표 확인 실패:', checkError);
                    throw checkError;
                }

                if (existingVote && existingVote.length > 0) {
                    alert('이미 투표하셨습니다.');
                    return;
                }

                // 투표 저장
                const { error: insertError } = await supabase
                    .from('vote_results')
                    .insert({
                        vote_id: voteId,
                        user_id: currentUser.id,
                        user_name: currentUser.name,
                        option: optionIdx
                    });

                if (insertError) {
                    console.error('투표 저장 실패:', insertError);
                    throw insertError;
                }

                alert('투표가 완료되었습니다!');
                selectedOption.classList.remove('selected');
            } catch (error) {
                console.error('투표 실패:', error);
                alert(`투표 중 오류가 발생했습니다: ${error.message}`);
            }
        }

        // 투표 생성 모달
        function openVoteCreateModal() {
            document.getElementById('voteCreateModal').style.display = 'flex';
        }

        async function createVote() {
            const type = document.getElementById('voteType').value;
            const title = document.getElementById('voteTitle').value.trim();
            const optionsText = document.getElementById('voteOptions').value.trim();

            if (!title || !optionsText) {
                document.getElementById('createVoteError').textContent = '제목과 선택지를 입력해주세요.';
                return;
            }

            if (containsBadWords(title + optionsText)) {
                document.getElementById('createVoteError').textContent = '부적절한 내용이 포함되어 있습니다.';
                return;
            }

            const options = optionsText.split('\n').filter(opt => opt.trim());
            if (options.length < 2) {
                document.getElementById('createVoteError').textContent = '최소 2개의 선택지가 필요합니다.';
                return;
            }

            // 투표 생성 데이터 준비
            const voteData = {
                type: type,
                title: title,
                options: options,
                created_by: currentUser.id,
                is_completed: false
            };

            try {
                const { error } = await supabase
                    .from('votes')
                    .insert(voteData);

                if (error) {
                    console.error('투표 생성 에러:', error);
                    throw error;
                }

                closeModal('voteCreateModal');
                document.getElementById('voteTitle').value = '';
                document.getElementById('voteOptions').value = '';
                document.getElementById('createVoteError').textContent = '';
                loadVotes();
                alert('투표가 생성되었습니다!');
            } catch (error) {
                console.error('투표 생성 실패:', error);
                document.getElementById('createVoteError').textContent = `투표 생성 중 오류가 발생했습니다: ${error.message}`;
            }
        }

        // 투표 삭제
        async function deleteVote(voteId) {
            if (!confirm('정말로 이 투표를 삭제하시겠습니까?\n투표 결과도 모두 삭제됩니다.')) return;

            try {
                await supabase.from('vote_results').delete().eq('vote_id', voteId);
                await supabase.from('votes').delete().eq('id', voteId);

                // 차트 인스턴스 정리
                if (activeCharts[voteId]) {
                    activeCharts[voteId].destroy();
                    delete activeCharts[voteId];
                }
                
                loadVotes();
                loadCompletedVotes();
                alert('투표가 삭제되었습니다.');
            } catch (error) {
                console.error('투표 삭제 실패:', error);
                alert('삭제 중 오류가 발생했습니다.');
            }
        }

        // 투표 완료
        async function completeVote(voteId) {
            if (!confirm('이 투표를 완료하시겠습니까?')) return;

            try {
                const { data: results } = await supabase
                    .from('vote_results')
                    .select('*')
                    .eq('vote_id', voteId);

                await supabase
                    .from('votes')
                    .update({ 
                        is_completed: true, 
                        completed_at: new Date().toISOString(),
                        results: results 
                    })
                    .eq('id', voteId);

                loadVotes();
                loadCompletedVotes();
                alert('투표가 완료되었습니다.');
            } catch (error) {
                console.error('투표 완료 실패:', error);
                alert('완료 처리 중 오류가 발생했습니다.');
            }
        }

        // 건의사항
        function openSuggestionModal() {
            document.getElementById('suggestionModal').style.display = 'flex';
        }

        function selectProfile(color) {
            selectedProfileColor = color;
            document.getElementById('selectedProfile').value = color;
            
            // 선택된 프로필 표시
            document.querySelectorAll('.profile-circle').forEach(circle => {
                circle.style.border = circle.style.backgroundColor === color ? '3px solid #333' : 'none';
            });
        }

        async function submitSuggestion() {
            const content = document.getElementById('suggestionContent').value.trim();
            
            if (!content) {
                document.getElementById('suggestionError').textContent = '내용을 입력해주세요.';
                return;
            }

            if (containsBadWords(content)) {
                document.getElementById('suggestionError').textContent = '부적절한 내용이 포함되어 있습니다.';
                return;
            }

            try {
                const { error } = await supabase
                    .from('suggestions')
                    .insert({
                        user_id: currentUser.id,
                        user_name: currentUser.name,
                        user_grade: currentUser.grade,
                        user_class: currentUser.class,
                        content: content,
                        profile_color: selectedProfileColor
                    });

                if (error) throw error;

                closeModal('suggestionModal');
                document.getElementById('suggestionContent').value = '';
                document.getElementById('suggestionError').textContent = '';
                if (currentUser.isAdmin) {
                    loadPublicSuggestions();
                }
                alert('건의사항이 제출되었습니다!');
            } catch (error) {
                console.error('건의사항 제출 실패:', error);
                document.getElementById('suggestionError').textContent = '제출 중 오류가 발생했습니다.';
            }
        }

        // 공개 건의사항 로드 (관리자만)
        async function loadPublicSuggestions() {
            try {
                console.log('공개 건의사항 로딩 시작...');
                
                const { data: suggestions, error } = await supabase
                    .from('suggestions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) {
                    console.error('건의사항 로드 에러:', error);
                    throw error;
                }

                console.log('로드된 건의사항:', suggestions);

                const suggestionsList = document.getElementById('publicSuggestionsList');
                if (!suggestions || suggestions.length === 0) {
                    suggestionsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">아직 건의사항이 없습니다.</p>';
                } else {
                    suggestionsList.innerHTML = suggestions.map(suggestion => `
                        <div class="suggestion-item">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <div class="profile-circle" style="background: ${suggestion.profile_color};">
                                    ${suggestion.user_name ? suggestion.user_name[0] : '?'}
                                </div>
                                <div>
                                    <strong>${suggestion.user_grade}학년 ${suggestion.user_class}반 ${suggestion.user_name}</strong>
                                </div>
                            </div>
                            <p>${suggestion.content}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('공개 건의사항 로드 실패:', error);
                const suggestionsList = document.getElementById('publicSuggestionsList');
                suggestionsList.innerHTML = `
                    <p style="text-align: center; color: #e74c3c; padding: 20px;">
                        건의사항을 불러오는데 실패했습니다.<br>
                        <small>오류: ${error.message}</small>
                    </p>
                `;
            }
        }

        // 건의사항 관리 (관리자용)
        async function viewSuggestions() {
            try {
                const { data: suggestions } = await supabase
                    .from('suggestions')
                    .select('*')
                    .order('created_at', { ascending: false });

                const suggestionsList = document.getElementById('suggestionsList');
                if (!suggestions || suggestions.length === 0) {
                    suggestionsList.innerHTML = '<p>건의사항이 없습니다.</p>';
                } else {
                    suggestionsList.innerHTML = suggestions.map(suggestion => `
                        <div class="suggestion-item">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <div class="profile-circle" style="background: ${suggestion.profile_color};">
                                    ${suggestion.user_name[0]}
                                </div>
                                <div>
                                    <strong>${suggestion.user_grade}학년 ${suggestion.user_class}반 ${suggestion.user_name}</strong>
                                </div>
                                <button class="btn btn-danger btn-small" onclick="deleteSuggestion(${suggestion.id})" style="margin-left: auto;">삭제</button>
                            </div>
                            <p>${suggestion.content}</p>
                        </div>
                    `).join('');
                }

                document.getElementById('suggestionsViewModal').style.display = 'flex';
            } catch (error) {
                console.error('건의사항 로드 실패:', error);
            }
        }

        async function deleteSuggestion(suggestionId) {
            if (!confirm('이 건의사항을 삭제하시겠습니까?')) return;

            try {
                await supabase.from('suggestions').delete().eq('id', suggestionId);
                viewSuggestions(); // 목록 새로고침
                loadPublicSuggestions(); // 메인 페이지도 새로고침
            } catch (error) {
                console.error('건의사항 삭제 실패:', error);
                alert('삭제 중 오류가 발생했습니다.');
            }
        }

        // 모달 관리
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // 모달 외부 클릭시 닫기
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // 페이지 언로드시 정리
        window.addEventListener('beforeunload', () => {
            // 차트 인스턴스 정리
            Object.values(activeCharts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
        });

        // 초기 프로필 색상 설정
        selectProfile('#3498db');
    </script>
</body>
</html>
